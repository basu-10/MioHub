<!-- Files Section Cards - For HTMX Rearrangement -->
{% for file in files %}
<div class="col d-flex">
  <div class="card flex-fill h-100 shadow-sm item-card" data-type="file" data-id="{{ file.id }}" data-file-type="{{ file.type }}" data-file-description="{{ file.metadata_json.get('description', '') if file.metadata_json else '' }}" data-is-public="{{ '1' if file.is_public else '0' }}" data-is-pinned="{{ '1' if file.is_pinned else '0' }}">
    <div class="badge-container">
      {% if file.is_pinned %}
        <span class="pin-badge" title="Pinned"><i class="material-icons" aria-hidden="true">push_pin</i><span class="visually-hidden">Pinned</span></span>
      {% endif %}
      {% if file.is_public %}
        <span class="public-badge"><i class="material-icons" aria-hidden="true">public</i><span class="visually-hidden">Public</span></span>
      {% endif %}
      <span class="type-badge">{{ file.type }}</span>
      {% if file.type == 'code' and file.metadata_json and file.metadata_json.get('language') %}
        <span class="subtype-badge">{{ file.metadata_json.get('language')|title }}</span>
      {% endif %}
    </div>
    <div class="card-body d-flex flex-column item-body" tabindex="0">
      <h5 class="card-title mb-2">
        <a href="{{ url_for('file.view_file', file_id=file.id) }}" class="item-link">{{ file.title }}</a>
      </h5>
      {% if file.metadata_json and file.metadata_json.get('description') and display_prefs.show_previews %}
      <div class="file-description content-preview mb-2">
        <i class="fas fa-info-circle me-1" style="color: var(--accent-green); font-size: 0.875rem;"></i>
        <span>{{ file.metadata_json.get('description') }}</span>
      </div>
      {% endif %}
      
      {% if file.type == 'todo' and display_prefs.show_previews and display_prefs.card_size in ['normal', 'large'] %}
      {% set raw_items = file.content_json.get('items', []) if file.content_json else [] %}
      {% if raw_items is sequence and raw_items is not string and raw_items|length > 0 %}
      {% set todo_items = raw_items if raw_items[0] is mapping else [] %}
      {% if todo_items %}
      <div class="content-preview todo-preview">
        {% set completed = todo_items | selectattr('completed', 'equalto', true) | list | length %}
        {% set total = todo_items | length %}
        {% set percentage = ((completed / total * 100) | round | int) if total > 0 else 0 %}
        <div class="d-flex align-items-center gap-2 mb-2">
          <span class="badge bg-secondary" style="font-size: 0.75rem;">{{ completed }}/{{ total }} done ({{ percentage }}%)</span>
          <div class="flex-grow-1" style="height: 4px; background: var(--border-primary); border-radius: 999px; overflow: hidden;">
            <div style="height: 100%; width: {{ percentage }}%; background: var(--accent); transition: width 0.3s ease;"></div>
          </div>
        </div>
        <div class="todo-items-preview">
          {% for item in todo_items[:5] %}
          {% if item is mapping and item.text is defined %}
          <div class="d-flex align-items-start gap-2 mb-1" style="font-size: 0.85rem;">
            {% if item.completed %}
            <i class="material-icons" style="font-size: 16px; color: var(--accent);">check_circle</i>
            <span style="text-decoration: line-through; opacity: 0.6;">{{ item.text[:50] }}{% if item.text|length > 50 %}...{% endif %}</span>
            {% else %}
            <i class="material-icons" style="font-size: 16px; color: var(--muted);">radio_button_unchecked</i>
            <span>{{ item.text[:50] }}{% if item.text|length > 50 %}...{% endif %}</span>
            {% endif %}
          </div>
          {% endif %}
          {% endfor %}
          {% if todo_items|length > 5 %}
          <div class="text-muted small mt-1">+ {{ todo_items|length - 5 }} more...</div>
          {% endif %}
        </div>
      </div>
      {% endif %}
      {% endif %}
      {% endif %}
    </div>
  </div>
</div>
{% endfor %}
