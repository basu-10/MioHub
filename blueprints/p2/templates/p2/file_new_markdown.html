<!-- Edit markdown file with EasyMDE editor and live preview -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if file %}Edit: {{ file.title }}{% else %}New Markdown File{% endif %} - MioSpace</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme_colors_carbon_teal.css') }}">
  
  <!-- EasyMDE CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
  
  <style>
    body {
      background: var(--bg);
      color: var(--white);
      min-height: 100vh;
    }
    
    .editor-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    .editor-header {
      background: var(--card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .editor-wrapper {
      background: var(--card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    /* EasyMDE Dark Theme Customization */
    .EasyMDEContainer {
      background: var(--bg);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
    }
    
    .EasyMDEContainer .CodeMirror {
      background: var(--bg);
      color: var(--white);
      border: none;
      min-height: 500px;
    }
    
    .EasyMDEContainer .editor-toolbar {
      background: var(--card);
      border-bottom: 1px solid var(--border-primary);
      opacity: 1;
    }
    
    .EasyMDEContainer .editor-toolbar button {
      color: var(--muted) !important;
    }
    
    .EasyMDEContainer .editor-toolbar button:hover,
    .EasyMDEContainer .editor-toolbar button.active {
      background: var(--accent);
      color: var(--white) !important;
      border-color: var(--accent);
    }
    
    .EasyMDEContainer .CodeMirror-cursor {
      border-left-color: var(--accent);
    }
    
    .EasyMDEContainer .editor-preview,
    .EasyMDEContainer .editor-preview-side {
      background: var(--bg);
      color: var(--white);
    }
    
    .EasyMDEContainer .editor-preview h1,
    .EasyMDEContainer .editor-preview h2,
    .EasyMDEContainer .editor-preview h3,
    .EasyMDEContainer .editor-preview-side h1,
    .EasyMDEContainer .editor-preview-side h2,
    .EasyMDEContainer .editor-preview-side h3 {
      color: var(--accent);
    }
    
    .EasyMDEContainer .editor-preview code,
    .EasyMDEContainer .editor-preview-side code {
      background: var(--card);
      color: var(--accent);
    }
    
    .EasyMDEContainer .editor-preview pre,
    .EasyMDEContainer .editor-preview-side pre {
      background: var(--card);
      border: 1px solid var(--border-primary);
    }
    
    .btn-primary {
      background: var(--accent);
      border: none;
      color: var(--white);
    }
    
    .btn-primary:hover {
      background: var(--accent-strong);
    }
    
    .form-control, .form-select {
      background: var(--bg);
      color: var(--white);
      border: 1px solid var(--border-primary);
    }
    
    .form-control:focus, .form-select:focus {
      background: var(--bg);
      color: var(--white);
      border-color: var(--accent);
      box-shadow: 0 0 0 0.2rem rgba(20, 184, 166, 0.25);
    }
  </style>
</head>
<body>
  <div class="editor-container">
    <div class="editor-header">
      <form id="markdown-form" method="POST" action="{% if file %}{{ url_for('file.edit_file', file_id=file.id) }}{% else %}{{ url_for('file.new_file', file_type='markdown') }}{% endif %}">
        <div class="row mb-3">
          <div class="col-md-8">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" 
                   value="{% if file %}{{ file.title }}{% endif %}" required>
          </div>
          <div class="col-md-4">
            <label class="form-label d-block">&nbsp;</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="is_public" name="is_public" 
                     {% if file and file.is_public %}checked{% endif %}>
              <label class="form-check-label" for="is_public">
                <i class="material-icons" style="font-size: 16px; vertical-align: middle;">public</i>
                Make Public
              </label>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label for="description" class="form-label">Description (optional)</label>
          <input type="text" class="form-control" id="description" name="description" 
                 value="{% if file and file.metadata_json %}{{ file.metadata_json.get('description', '') }}{% endif %}"
                 placeholder="Brief description of this markdown file">
        </div>
        
        <input type="hidden" id="content" name="content" value="">
        
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <button type="submit" class="btn btn-primary">
              <i class="material-icons" style="font-size: 18px; vertical-align: middle;">save</i>
              Save
            </button>
            <a href="{{ url_for('folders.view_folder', folder_id=session.get('current_folder_id', 1)) }}" class="btn btn-outline-secondary ms-2">
              <i class="material-icons" style="font-size: 18px; vertical-align: middle;">close</i>
              Cancel
            </a>
          </div>
          <div class="text-muted small">
            <i class="material-icons" style="font-size: 16px; vertical-align: middle;">info</i>
            Supports GitHub Flavored Markdown
          </div>
        </div>
      </form>
    </div>
    
    <div class="editor-wrapper">
      <textarea id="markdown-editor">{% if file and file.content_text %}{{ file.content_text }}{% else %}# Welcome to Markdown Editor

## Features
- **Bold** and *italic* text
- Lists and checkboxes
- Code blocks with syntax highlighting
- Tables and links
- Live preview

Start writing your markdown here...{% endif %}</textarea>
    </div>
  </div>
  
  <!-- EasyMDE JS -->
  <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
  
  <script>
    // Initialize EasyMDE with side-by-side preview
    const easyMDE = new EasyMDE({
      element: document.getElementById('markdown-editor'),
      autofocus: true,
      spellChecker: false,
      toolbar: [
        "bold", "italic", "heading", "|",
        "quote", "unordered-list", "ordered-list", "code", "|",
        "link", "image", "table", "horizontal-rule", "|",
        "preview", "side-by-side", "fullscreen", "|",
        "guide"
      ],
      renderingConfig: {
        codeSyntaxHighlighting: true,
      },
      status: ["lines", "words", "cursor"],
      placeholder: "Type your markdown here...",
      sideBySideFullscreen: false,
    });
    
    // Sync editor content to hidden input on form submit
    document.getElementById('markdown-form').addEventListener('submit', function(e) {
      document.getElementById('content').value = easyMDE.value();
    });
    
    // Keyboard shortcut: Ctrl+S to save
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('markdown-form').submit();
      }
    });
  </script>
</body>
</html>
