<!-- folder_view_folders_tab.html -->
<!-- Folders Tab Content - Extracted for better maintainability -->

<div class="folder-tree-loading">
  <i class="material-icons">hourglass_empty</i>
  <p>Loading folders...</p>
</div>

<script>
// Folder Tree State and Functions
let folderTreeData = [];
let expandedFolders = new Set();
let draggedFolder = null;

// Initialize folder tree on load
document.addEventListener('DOMContentLoaded', function() {
  // Load expanded folders from localStorage
  const savedExpanded = localStorage.getItem('expandedFolders');
  if (savedExpanded) {
    expandedFolders = new Set(JSON.parse(savedExpanded));
  }
  
  // Load folder tree
  loadFolderTree();
});

// Load Folder Tree from API
async function loadFolderTree() {
  const container = document.getElementById('foldersTabContent');
  
  try {
    // console.log('Loading folder tree for user...');
    const response = await fetch('/folders/api/folder-tree');
    const data = await response.json();
    
    // console.log('Folder tree API response:', data);
    
    if (data.success) {
      folderTreeData = data.folders;
      // console.log(`Loaded ${data.folders.length} root folders for user "${data.username}" (ID: ${data.user_id})`);
      // console.log('Root folders:', data.folders.map(f => f.name));
      // console.log('Total folder count:', data.total_count);
      renderFolderTree();
    } else {
      console.error('Failed to load folders:', data.message || 'Unknown error');
      container.innerHTML = '<div class="folder-tree-empty">Failed to load folders</div>';
    }
  } catch (error) {
    console.error('Error loading folder tree:', error);
    container.innerHTML = '<div class="folder-tree-empty">Error loading folders</div>';
  }
}

// Render Folder Tree
function renderFolderTree() {
  const container = document.getElementById('foldersTabContent');
  
  if (folderTreeData.length === 0) {
    // console.log('No folders found, showing empty state');
    container.innerHTML = `
      <div class="folder-tree-empty">
        <i class="material-icons" style="font-size: 48px; opacity: 0.3;">folder_off</i>
        <p>No folders yet</p>
        <button onclick="createNewFolder()" class="btn btn-sm btn-outline-primary mt-2">
          Create First Folder
        </button>
      </div>
    `;
    return;
  }
  
  // console.log('Rendering folder tree with', folderTreeData.length, 'root folders');
  
  // Auto-expand to show current folder
  autoExpandToCurrentFolder();
  
  const tree = document.createElement('ul');
  tree.className = 'folder-tree';
  
  // If there are multiple root folders, create a virtual "Home" root
  if (folderTreeData.length > 1) {
    // console.log(`Multiple root folders detected (${folderTreeData.length}), creating virtual Home root`);
    const virtualHome = {
      id: 'home',
      name: 'Home',
      parent_id: null,
      children: folderTreeData,
      note_count: 0,
      board_count: 0,
      subfolder_count: folderTreeData.length,
      created_at: null,
      isVirtual: true
    };
    tree.appendChild(createFolderNode(virtualHome));
  } else {
    // Single root folder, show it directly
    folderTreeData.forEach(folder => {
      tree.appendChild(createFolderNode(folder));
    });
  }
  
  container.innerHTML = '';
  container.appendChild(tree);
  
  // console.log('Folder tree rendered successfully');
}

// Create Folder Node
function createFolderNode(folder) {
  const li = document.createElement('li');
  li.className = 'folder-tree-item';
  li.dataset.folderId = folder.id;
  
  const hasChildren = folder.children && folder.children.length > 0;
  const isExpanded = expandedFolders.has(String(folder.id)) || (folder.isVirtual && folderTreeData.length > 1);
  
  // Get current folder ID from localStorage or URL
  const currentFolderId = getCurrentFolderId();
  const isActive = folder.id == currentFolderId && !folder.isVirtual;
  
  // console.log(`Creating node for folder ${folder.id} (${folder.name}):`, {
  //   currentFolderId,
  //   isActive,
  //   hasChildren,
  //   isExpanded,
  //   isVirtual: folder.isVirtual
  // });
  
  const totalCount = (folder.note_count || 0) + (folder.board_count || 0);
  
  const node = document.createElement('div');
  node.className = 'folder-tree-node' + (isActive ? ' active' : '');
  
  // Virtual home folder shouldn't be draggable
  if (!folder.isVirtual) {
    node.draggable = true;
  }
  
  node.innerHTML = `
    <span class="folder-expand-icon ${isExpanded ? 'expanded' : ''} ${!hasChildren ? 'empty' : ''}" onclick="toggleFolder('${folder.id}')">
      ${hasChildren ? '<i class="material-icons" style="font-size: 16px;">chevron_right</i>' : ''}
    </span>
    <i class="material-icons folder-icon">${folder.isVirtual ? 'home' : (isExpanded ? 'folder_open' : 'folder')}</i>
    <span class="folder-name">${escapeHtml(folder.name)}</span>
    ${totalCount > 0 ? `<span class="folder-count">${totalCount}</span>` : ''}
  `;
  
  // Click to navigate (virtual home folder doesn't navigate)
  node.addEventListener('click', function(e) {
    if (!e.target.closest('.folder-expand-icon') && !folder.isVirtual) {
      navigateToFolder(folder.id);
    }
  });
  
  // Right click for context menu (disabled for virtual home)
  if (!folder.isVirtual) {
    node.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      showContextMenu(e, folder);
    });
  }
  
  // Drag and drop (disabled for virtual home)
  if (!folder.isVirtual) {
    node.addEventListener('dragstart', function(e) {
      draggedFolder = folder;
      e.dataTransfer.effectAllowed = 'move';
      node.style.opacity = '0.5';
    });
  }
  
  node.addEventListener('dragend', function(e) {
    node.style.opacity = '1';
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  });
  
  node.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    if (draggedFolder && draggedFolder.id !== folder.id) {
      node.classList.add('drag-over');
    }
  });
  
  node.addEventListener('dragleave', function(e) {
    node.classList.remove('drag-over');
  });
  
  node.addEventListener('drop', function(e) {
    e.preventDefault();
    node.classList.remove('drag-over');
    if (draggedFolder && draggedFolder.id !== folder.id) {
      moveFolder(draggedFolder.id, folder.id);
    }
  });
  
  li.appendChild(node);
  
  // Add children if present
  if (hasChildren) {
    const childrenUl = document.createElement('ul');
    childrenUl.className = 'folder-tree-children' + (isExpanded ? ' expanded' : '');
    
    folder.children.forEach(child => {
      childrenUl.appendChild(createFolderNode(child));
    });
    
    li.appendChild(childrenUl);
  }
  
  return li;
}

// Toggle Folder Expand/Collapse
function toggleFolder(folderId) {
  // console.log('Toggling folder:', folderId);
  
  // Convert to string for consistent comparison
  const folderIdStr = String(folderId);
  
  if (expandedFolders.has(folderIdStr)) {
    expandedFolders.delete(folderIdStr);
  } else {
    expandedFolders.add(folderIdStr);
  }
  
  // Save to localStorage
  localStorage.setItem('expandedFolders', JSON.stringify([...expandedFolders]));
  
  // Re-render tree
  renderFolderTree();
}

// Navigate to Folder
function navigateToFolder(folderId) {
  window.location.href = `/folders/${folderId}`;
}

// Create New Folder
function createNewFolder(parentId = null) {
  const name = prompt('Enter folder name:');
  if (!name || !name.trim()) return;
  
  const formData = new FormData();
  formData.append('name', name.trim());
  if (parentId) formData.append('parent_id', parentId);
  
  fetch('/folders/create', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.ok) {
      refreshFolderTree();
    } else {
      alert('Failed to create folder');
    }
  })
  .catch(error => {
    console.error('Error creating folder:', error);
    alert('Error creating folder');
  });
}

// Rename Folder
function renameFolder(folderId) {
  const folder = findFolderById(folderId);
  if (!folder) return;
  
  const newName = prompt('Enter new name:', folder.name);
  if (!newName || !newName.trim() || newName === folder.name) return;
  
  const formData = new FormData();
  formData.append('name', newName.trim());
  
  fetch(`/folders/rename/${folderId}`, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      refreshFolderTree();
    } else {
      alert('Failed to rename folder');
    }
  })
  .catch(error => {
    console.error('Error renaming folder:', error);
    alert('Error renaming folder');
  });
}

// Move Folder (Drag & Drop)
function moveFolder(folderId, targetParentId) {
  const formData = new FormData();
  formData.append('target_parent_id', targetParentId);
  
  fetch(`/folders/move/${folderId}`, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.ok) {
      refreshFolderTree();
    } else {
      alert('Failed to move folder');
    }
  })
  .catch(error => {
    console.error('Error moving folder:', error);
    alert('Error moving folder');
  });
}

// Delete Folder
function deleteFolder(folderId) {
  const folder = findFolderById(folderId);
  if (!folder) return;
  
  if (!confirm(`Are you sure you want to delete "${folder.name}" and all its contents?`)) return;
  
  fetch(`/folders/delete/${folderId}`, {
    method: 'POST'
  })
  .then(response => {
    if (response.ok) {
      refreshFolderTree();
      // If we deleted the current folder, go to dashboard
      if (folder.id == localStorage.getItem('currentFolderId')) {
        window.location.href = '/product2';
      }
    } else {
      alert('Failed to delete folder');
    }
  })
  .catch(error => {
    console.error('Error deleting folder:', error);
    alert('Error deleting folder');
  });
}

// Refresh Folder Tree
function refreshFolderTree() {
  loadFolderTree();
}

// Utility Functions
function findFolderById(id, folders = folderTreeData) {
  for (let folder of folders) {
    if (folder.id === id) return folder;
    if (folder.children) {
      const found = findFolderById(id, folder.children);
      if (found) return found;
    }
  }
  return null;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getCurrentFolderId() {
  // Try multiple sources to get current folder ID
  const sources = [
    () => localStorage.getItem('currentFolderId'),
    () => window.location.pathname.match(/\/folders\/(\d+)/)?.[1],
    () => document.querySelector('[data-current-folder-id]')?.dataset.currentFolderId
  ];
  
  for (let source of sources) {
    try {
      const id = source();
      if (id) {
        // console.log('Found current folder ID:', id);
        return parseInt(id);
      }
    } catch (e) {
      console.warn('Error getting folder ID from source:', e);
    }
  }
  
  console.warn('Could not determine current folder ID');
  return null;
}

function findPathToFolder(targetId, folders = folderTreeData) {
  /**
   * Find the path (array of folder IDs) from root to target folder
   * Used to auto-expand the tree to show current folder
   */
  for (let folder of folders) {
    if (folder.id === targetId) {
      return [folder.id];
    }
    if (folder.children && folder.children.length > 0) {
      const childPath = findPathToFolder(targetId, folder.children);
      if (childPath) {
        return [folder.id, ...childPath];
      }
    }
  }
  return null;
}

function autoExpandToCurrentFolder() {
  /**
   * Auto-expand tree to show the current folder
   */
  const currentFolderId = getCurrentFolderId();
  if (!currentFolderId) return;
  
  // console.log('Auto-expanding to show folder:', currentFolderId);
  
  const path = findPathToFolder(currentFolderId);
  if (path) {
    // console.log('Found path to current folder:', path);
    // Expand all folders in the path except the last one (current folder)
    for (let i = 0; i < path.length - 1; i++) {
      expandedFolders.add(path[i]);
    }
    // Save expanded state
    localStorage.setItem('expandedFolders', JSON.stringify([...expandedFolders]));
  } else {
    console.warn('Could not find path to current folder');
  }
}
</script>
