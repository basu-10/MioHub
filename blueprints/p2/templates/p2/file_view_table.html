<!-- View table file (read-only) with Luckysheet -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ file.title }} - MioSpace</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme_colors_carbon_teal.css') }}">
  
  <!-- Luckysheet CSS -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css' />
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css' />
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css' />
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css' />
  
  <style>
    body {
      background: var(--bg);
      color: var(--white);
      min-height: 100vh;
    }
    
    .viewer-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    .viewer-header {
      background: var(--card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .table-viewer {
      background: var(--card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    /* Luckysheet container */
    #luckysheet {
      width: 100%;
      height: 600px;
      margin: 0;
      padding: 0;
    }
    
    .stats {
      display: flex;
      gap: 1.5rem;
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg);
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    
    .stats span {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: var(--accent);
      border: none;
    }
    
    .btn-primary:hover {
      background: var(--accent-strong);
    }
  </style>
</head>
<body>
  <div class="viewer-container">
    <div class="viewer-header">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h2>{{ file.title }}</h2>
          {% if file.metadata_json and file.metadata_json.get('description') %}
          <p class="text-muted mb-0">{{ file.metadata_json.get('description') }}</p>
          {% endif %}
        </div>
        <div class="d-flex gap-2">
          {% if public_view %}
          <button class="btn btn-outline-secondary btn-copy-public" data-file-id="{{ file.id }}" data-file-type="file">
            <i class="material-icons" style="font-size: 18px; vertical-align: middle;">content_copy</i>
            Copy to My Profile
          </button>
          {% endif %}
          {% if current_user.is_authenticated and file.owner_id == current_user.id %}
          <a href="{{ url_for('file.edit_file', file_id=file.id) }}" class="btn btn-primary">
            <i class="material-icons" style="font-size: 18px; vertical-align: middle;">edit</i>
            Edit
          </a>
          {% endif %}
          <button type="button" id="export-csv" class="btn btn-outline-secondary">
            <i class="material-icons" style="font-size: 18px; vertical-align: middle;">download</i>
            Export CSV
          </button>
          <a href="javascript:history.back()" class="btn btn-outline-secondary">
            <i class="material-icons" style="font-size: 18px; vertical-align: middle;">arrow_back</i>
            Back
          </a>
        </div>
      </div>
    </div>
    
    <div class="table-viewer">
      <div id="luckysheet"></div>
      
      <div class="stats">
        <span><i class="material-icons">info</i> Read-only view â€¢ Use Edit button to modify</span>
      </div>
    </div>
  </div>
  
  <!-- Luckysheet JS -->
  <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>
  
  <script>
    // Safely parse file content with fallback
    let rawData = {{ file.content_json|tojson|safe }};
    let luckysheetData = [];
    
    // Convert legacy Tabulator format to Luckysheet format
    if (rawData && typeof rawData === 'object') {
      if (Array.isArray(rawData)) {
        // Already in Luckysheet format (array of sheets)
        luckysheetData = rawData;
      } else if (rawData.data && rawData.columns) {
        // Legacy Tabulator format - convert to Luckysheet
        console.log('Converting Tabulator format to Luckysheet');
        const headers = rawData.columns.map(col => col.title || col.field);
        const rows = [headers];
        
        rawData.data.forEach(row => {
          const rowData = rawData.columns.map(col => row[col.field] || '');
          rows.push(rowData);
        });
        
        luckysheetData = [{
          "name": "Sheet1",
          "color": "",
          "status": 1,
          "order": 0,
          "data": rows,
          "config": {},
          "index": 0
        }];
      } else {
        // Unknown format - create empty sheet
        console.warn('Unknown data format, creating empty sheet');
        luckysheetData = [{
          "name": "Sheet1",
          "color": "",
          "status": 1,
          "order": 0,
          "data": [["No data available"]],
          "config": {},
          "index": 0
        }];
      }
    } else {
      // No data - create default empty sheet
      luckysheetData = [{
        "name": "Sheet1",
        "color": "",
        "status": 1,
        "order": 0,
        "data": [["No data available"]],
        "config": {},
        "index": 0
      }];
    }
    
    // Initialize Luckysheet in read-only mode
    try {
      luckysheet.create({
        container: 'luckysheet',
        data: luckysheetData,
        showinfobar: false,
        showsheetbar: true,
        showstatisticBar: true,
        sheetFormulaBar: true,
        enableAddRow: false,
        enableAddBackTop: false,
        userInfo: false,
        myFolderUrl: '',
        title: '{{ file.title }}',
        lang: 'en',
        allowEdit: false,
        showToolbar: false
      });
    } catch (e) {
      console.error('Failed to initialize Luckysheet:', e);
      document.getElementById('luckysheet').innerHTML = '<div style="padding: 20px; color: #f44336;">Error loading table data. Please try editing the file.</div>';
    }
    
    // Export CSV
    document.getElementById('export-csv').addEventListener('click', function() {
      try {
        const sheetData = luckysheet.getSheetData();
        if (!sheetData || sheetData.length === 0) {
          alert('No data to export');
          return;
        }
        
        // Convert to CSV
        const csv = sheetData.map(row => {
          return row.map(cell => {
            const value = cell && cell.v !== undefined ? cell.v : '';
            // Quote if contains comma or quotes
            const stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('"')) {
              return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            return stringValue;
          }).join(',');
        }).join('\n');
        
        // Download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = '{{ file.title }}.csv';
        a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error('Export error:', e);
        alert('Error exporting data. Please try again.');
      }
    });
    
    // Copy to profile functionality
    document.querySelectorAll('.btn-copy-public').forEach(btn => {
      btn.addEventListener('click', function() {
        const fileId = btn.dataset.fileId;
        btn.disabled = true;
        btn.textContent = 'Copying...';
        
        fetch('/folders/public/copy/file/' + fileId, { method: 'POST' })
          .then(r => r.json())
          .then(data => {
            if (data.success && data.new_id) {
              window.location.href = '/p2/files/' + data.new_id + '/edit';
            } else {
              alert('Copy failed: ' + (data.message || 'Unknown error'));
              btn.disabled = false;
              btn.innerHTML = '<i class="material-icons" style="font-size: 18px; vertical-align: middle;">content_copy</i> Copy to My Profile';
            }
          })
          .catch(err => {
            console.error(err);
            alert('Copy failed');
            btn.disabled = false;
            btn.innerHTML = '<i class="material-icons" style="font-size: 18px; vertical-align: middle;">content_copy</i> Copy to My Profile';
          });
      });
    });
  </script>
</body>
</html>
