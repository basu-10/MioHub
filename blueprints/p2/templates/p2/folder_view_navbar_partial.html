<!-- ðŸ“ Navbar -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/theme_colors_carbon_teal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/telemetry_panel.css') }}">
<style>
  /* Scoped overrides for navbar elements to align with Carbon Teal theme */
  .bg-gray-900 { background: var(--bg) !important; }
  .bg-gray-800 { background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%) !important; }
  .text-white { color: var(--text-primary) !important; }
  .text-gray-200, .text-gray-300, .text-gray-400 { color: var(--text-secondary) !important; }

  /* User type badge styling */
  .user-type-badge {
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    background: transparent;
    padding: 0.125rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    line-height: 1;
    vertical-align: middle;
  }

  /* Dropdown styles */
  .dropdown-custom {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  }
  .dropdown-custom li a {
    color: var(--text-primary) !important;
  }
  .dropdown-custom li a:hover {
    background: var(--hover-overlay);
  }
  .dropdown-custom li a .material-icons {
    color: var(--accent) !important;
  }
  .dropdown-custom li a .muted {
    color: var(--text-secondary) !important;
  }

  /* Modal theming */
  #exportImportModal .bg-gray-800 { 
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%) !important; 
  }

  /* Mobile responsive navbar */
  @media (max-width: 768px) {
    .px-6 {
      padding-left: 0.75rem !important;
      padding-right: 0.75rem !important;
    }

    .h-16 {
      height: 3.5rem !important;
    }

    /* Hide less critical navbar elements on mobile */
    .user-type-badge {
      font-size: 0.65rem !important;
      padding: 0.1rem 0.35rem !important;
    }

    /* Make navbar text smaller on mobile */
    nav .text-xl {
      font-size: 1.1rem !important;
    }

    nav .text-sm {
      font-size: 0.75rem !important;
    }

    /* Adjust dropdown positioning for mobile */
    .dropdown-custom {
      max-width: 90vw;
      left: 5vw !important;
      right: 5vw !important;
    }

    /* Telemetry panel mobile adjustments */
    .telemetry-widget {
      max-width: 120px;
    }

    /* Hide welcome text on mobile */
    .navbar-welcome-text {
      display: none !important;
    }
  }

  @media (max-width: 575px) {
    .px-6 {
      padding-left: 0.5rem !important;
      padding-right: 0.5rem !important;
    }

    /* Hide non-essential text on very small screens */
    .hidden-xs-text {
      display: none !important;
    }

    /* Make MioSpace brand smaller */
    nav .text-xl {
      font-size: 1rem !important;
    }
  }
</style>
<!-- Navbar inherits z-index from header container (950) -->
<nav class="bg-gray-900 text-white w-full shadow-lg">
  <div class="w-full px-6">
    <div class="flex justify-between items-center h-16">
      <!-- Combined Logo/Brand Dropdown -->
      <div class="relative dropdown">
        <button id="mainMenuBtn" class="flex items-center hover:bg-gray-800 rounded-lg px-3 py-2 transition duration-200" aria-haspopup="true" aria-expanded="false" aria-controls="mainMenuDropdown">
          <div class="miospace-logo mr-2">
            <span class="mio">Mio</span><span class="space">Space</span>
          </div>
          <i class="material-icons text-sm" style="color: var(--accent);">arrow_drop_down</i>
        </button>
        
        <!-- Combined Dropdown Menu -->
        <ul id="mainMenuDropdown" class="absolute left-0 top-full mt-1 w-64 dropdown-custom hidden z-50" role="menu" aria-labelledby="mainMenuBtn" style="max-height: 80vh; overflow-y: auto;">
          
          <!-- Navigation Section -->
          <li class="px-3 py-2 text-xs font-semibold uppercase tracking-wider" style="color: var(--muted); border-bottom: 1px solid var(--border-primary);">
            Navigation
          </li>
          <li><a class="block px-4 py-2 text-sm hover:bg-gray-100 no-underline flex items-center" href="{{ url_for('core_blueprint.landing') }}">
            <i class="material-icons mr-2 text-sm">home</i>Home
          </a></li>
          <li><a class="block px-4 py-2 text-sm hover:bg-gray-100 no-underline flex items-center" href="{{ url_for('p3_bp.chatbot') }}">
            <i class="material-icons mr-2 text-sm">chat</i>MioChat
          </a></li>

          <!-- Divider -->
          <li class="my-2" style="border-top: 1px solid var(--border-primary);"></li>

          <!-- User Section -->
          <li class="px-3 py-2 text-xs font-semibold uppercase tracking-wider" style="color: var(--muted); border-bottom: 1px solid var(--border-primary);">
            User Settings
          </li>
          <li id="userStorageItem"><a class="block px-4 py-2 text-sm hover:bg-gray-100 no-underline flex items-center" href="#" onclick="event.preventDefault();">
            <i class="material-icons mr-2 text-sm">storage</i>
            {% set used_mb = (current_user.total_data_size or 0) / (1024 * 1024) %}
            {% if current_user.user_type == 'guest' %}
              {% set remaining_mb = 50 - used_mb %}
              <span id="storageText">{{ "%.1f"|format(used_mb) }} / {{ "%.1f"|format(remaining_mb if remaining_mb > 0 else 0) }} MB</span>
            {% else %}
              <span id="storageText">{{ "%.1f"|format(used_mb) }} MB</span>
            {% endif %}
          </a></li>
          <li><a class="block px-4 py-2 text-sm hover:bg-gray-100 no-underline flex items-center" href="{{ url_for('p2_bp.assets') }}">
            <i class="material-icons mr-2 text-sm">photo</i>Picture Assets
          </a></li>
          <li><a class="block px-4 py-2 text-sm hover:bg-gray-100 no-underline flex items-center" href="{{ url_for('p2_bp.profile') }}">
            <i class="material-icons mr-2 text-sm">person</i>Profile
          </a></li>
          <li><a class="block px-4 py-2 text-sm hover:bg-gray-100 no-underline flex items-center" href="#" onclick="openExportImportModal()">
            <i class="material-icons mr-2 text-sm">import_export</i>Export/Import Data
          </a></li>
          <li><a class="block px-4 py-2 text-sm hover:bg-gray-100 no-underline flex items-center" href="#" onclick="openSettingsModal()">
            <i class="material-icons mr-2 text-sm">settings</i>Settings
          </a></li>
          <li><a class="block px-4 py-2 text-sm hover:bg-gray-100 no-underline flex items-center" href="{{ url_for('p2_bp.logout') }}">
            <i class="material-icons mr-2 text-sm">logout</i>Logout
          </a></li>
        </ul>
      </div>

      <!-- Brand / User Greeting -->
      <a class="text-xl font-semibold text-white hover:text-gray-200 no-underline flex items-center" href="{{ url_for('folders.view_folder', folder_id=current_folder_id or current_user.folders[0].id) }}">
        <span class="navbar-welcome-text">Hi {{ current_user.username }}, welcome to MioSpace</span>
        {%- if current_user.user_type %}
          <span class="ml-2 text-gray-300 text-xs font-medium uppercase px-2 py-0.5 rounded user-type-badge" title="{{ current_user.user_type }}">{{ current_user.user_type|capitalize }}</span>
        {%- endif %}
      </a>
      
      <!-- Navigation Items -->
      <div class="flex items-center space-x-4">
        <!-- TelemetryPanel: Oscilloscope-style diagnostic display -->
        {% include 'p2/telemetry_panel_partial.html' %}
      </div>
    </div>
  </div>
</nav>

<!-- Storage status for guest users is shown inside the User dropdown and updated dynamically via JS -->

<script>
// Poll the server for storage usage and update the User dropdown text.
// Also update when the page becomes visible again.
function formatMB(bytes) {
  return (bytes / (1024 * 1024)).toFixed(1);
}

async function updateStorageText() {
  try {
    const resp = await fetch('{{ url_for("p2_bp.storage_status") }}', { credentials: 'same-origin' });
    if (!resp.ok) return;
    const data = await resp.json();
    const used = Number(data.used_bytes || 0);
    const total = (typeof data.total_bytes === 'number') ? data.total_bytes : null;
    const remaining = (typeof data.remaining_bytes === 'number') ? data.remaining_bytes : (total !== null ? total - used : null);
    const usedMB = formatMB(used);
    let text;
    if (total !== null) {
      const remainingMB = formatMB(Math.max(remaining || 0, 0));
      text = `Used/Remaining: ${usedMB} MB / ${remainingMB} MB`;
    } else {
      text = `Used: ${usedMB} MB (Unlimited)`;
    }
    const el = document.getElementById('storageText');
    if (el) {
      el.textContent = text;
    }
  } catch (e) {
    // silent fail
    console.error('Failed to update storage text', e);
  }
}

// Poll every 30 seconds (reduced from 8s to minimize server load)
setInterval(updateStorageText, 30000);
// Update on visibility change (when user returns to tab)
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) updateStorageText();
});

// Initial call after DOM ready
document.addEventListener('DOMContentLoaded', function() {
  updateStorageText();
});
</script>

<!-- Main Menu Dropdown Handler -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const mainMenuBtn = document.getElementById('mainMenuBtn');
  const mainMenuDropdown = document.getElementById('mainMenuDropdown');
  
  if (mainMenuBtn && mainMenuDropdown) {
    // Toggle dropdown on button click
    mainMenuBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      const isHidden = mainMenuDropdown.classList.contains('hidden');
      
      // Close all other dropdowns first
      document.querySelectorAll('.dropdown-custom').forEach(dd => dd.classList.add('hidden'));
      
      if (isHidden) {
        mainMenuDropdown.classList.remove('hidden');
        mainMenuBtn.setAttribute('aria-expanded', 'true');
      } else {
        mainMenuDropdown.classList.add('hidden');
        mainMenuBtn.setAttribute('aria-expanded', 'false');
      }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!mainMenuBtn.contains(e.target) && !mainMenuDropdown.contains(e.target)) {
        mainMenuDropdown.classList.add('hidden');
        mainMenuBtn.setAttribute('aria-expanded', 'false');
      }
    });
    
    // Close dropdown when clicking a link inside it
    mainMenuDropdown.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', function() {
        mainMenuDropdown.classList.add('hidden');
        mainMenuBtn.setAttribute('aria-expanded', 'false');
      });
    });
  }
});
</script>

<!-- Reparent navbar dropdowns to document.body when opened to avoid clipping behind other UI elements -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const navbar = document.querySelector('nav');
  if (!navbar) return;

  const hasPopper = !!(window.Popper && typeof window.Popper.createPopper === 'function');

  navbar.querySelectorAll('.dropdown').forEach(dropdown => {
    const toggle = dropdown.querySelector('[data-bs-toggle="dropdown"]');
    const menu = dropdown.querySelector('.dropdown-menu');
    if (!toggle || !menu) return;

    let placeholder = null;
    let popperInstance = null;

    dropdown.addEventListener('show.bs.dropdown', function () {
      placeholder = document.createElement('div');
      placeholder.className = 'dropdown-placeholder d-none';
      dropdown.insertBefore(placeholder, menu);

      document.body.appendChild(menu);
      menu.style.position = 'absolute';
      menu.style.zIndex = '99999';

      if (hasPopper) {
        popperInstance = Popper.createPopper(toggle, menu, {
          placement: (menu.classList.contains('dropdown-menu-end') ? 'bottom-end' : 'bottom-start'),
          modifiers: [
            { name: 'offset', options: { offset: [0, 8] } },
            { name: 'preventOverflow', options: { boundary: document.documentElement, padding: 8 } },
            { name: 'flip', options: { fallbackPlacements: ['top-start', 'top-end', 'bottom-start', 'bottom-end'] } },
            { name: 'computeStyles', options: { adaptive: false } }
          ]
        });
      } else {
        const rect = toggle.getBoundingClientRect();
        menu.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        menu.style.left = (rect.left + window.scrollX) + 'px';
      }
    });

    dropdown.addEventListener('hide.bs.dropdown', function () {
      if (popperInstance) { try { popperInstance.destroy(); } catch (e) {} popperInstance = null; }
      if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.insertBefore(menu, placeholder);
        placeholder.parentNode.removeChild(placeholder);
        placeholder = null;
      }
      menu.style.position = '';
      menu.style.top = '';
      menu.style.left = '';
      menu.style.right = '';
      menu.style.bottom = '';
      menu.style.zIndex = '';
    });

    dropdown.addEventListener('shown.bs.dropdown', function () {
      if (popperInstance && typeof popperInstance.update === 'function') popperInstance.update();
    });
  });
});

// Note: Summernote modal theming & assets injection logic has been moved to the
// note toolbar partial to scope behavior specifically to editor pages.
</script>

{# Flash messages: folder views include this navbar but do not extend core/base.html, so show flashes here too. #}
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div style="margin-top:70px;">
      <div class="container px-4">
        <div class="alert alert-warning">{{ messages[0] }}</div>
      </div>
    </div>
  {% endif %}
{% endwith %}

<!-- Combined Export/Import Modal -->
<div id="exportImportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center overflow-y-auto p-4" style="z-index: 12000;">
  <div class="export-import-shell max-w-5xl w-full my-8 max-h-[92vh] overflow-y-auto" style="background: linear-gradient(145deg,var(--bg-secondary) 0%, var(--bg-tertiary) 100%);">
    <!-- Modal Header -->
    <div class="ei-header">
      <div class="flex items-start gap-3">
        <div class="ei-icon">
          <i class="material-icons">import_export</i>
        </div>
        <div>
          <div class="text-lg font-semibold" style="color:var(--text-primary)">Export/Import Data</div>
          <p class="text-sm" style="color:var(--text-secondary)">Move everything in or out of the current folder without losing structure or fidelity.</p>
        </div>
      </div>
      <button type="button" class="ei-close" aria-label="Close" onclick="closeExportImportModal()">
        <i class="material-icons">close</i>
      </button>
    </div>

    <!-- Modal Body - Scrollable -->
    <div class="p-6 space-y-5" style="max-height: calc(92vh - 96px);">
      <div class="ei-meta-bar">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="ei-chip">Current folder</span>
          <span class="ei-folder-path" id="currentFolderBadge">
            {% if session.get('current_breadcrumb') %}
              {% for crumb_id, crumb_name in session.get('current_breadcrumb') %}
                {{ crumb_name }}{% if not loop.last %} â€º {% endif %}
              {% endfor %}
            {% else %}
              Root Folder
            {% endif %}
          </span>
        </div>
        <div class="ei-pill">
          <i class="material-icons text-xs mr-1">lock</i>
          Private exports stay on your device unless you import them back here.
        </div>
      </div>

      <div class="ei-grid">
        <!-- Export Column -->
        <div class="ei-card">
          <div class="ei-card-header">
            <div>
              <div class="ei-label">Export current folder</div>
              <p class="ei-subtext">Bundle all MioNote, MioPages, MioBlocks, images, and related assets.</p>
            </div>
            <span class="ei-badge success">Ready</span>
          </div>

          <div class="ei-subcard">
            <div class="ei-subcard-head">
              <div class="flex items-center gap-2">
                <div class="ei-dot success"></div>
                <div>
                  <div class="ei-subtitle">ZIP backup (restore-capable)</div>
                  <p class="ei-helper">Best for full fidelity restores back into MioSpace.</p>
                </div>
              </div>
              <a href="{{ url_for('notes.export_notes') }}" class="ei-action primary">
                <i class="material-icons text-sm">folder_zip</i>
                <span>Export as ZIP</span>
              </a>
            </div>
            <ul class="ei-bullets">
              <li>Includes MioNote, MioPages, MioBlocks, images, and subfolders.</li>
              <li>Re-import to restore structure; not viewable in third-party apps.</li>
            </ul>
          </div>

          <div class="ei-subcard">
            <div class="ei-subcard-head">
              <div class="flex items-center gap-2">
                <div class="ei-dot info"></div>
                <div>
                  <div class="ei-subtitle">PDF export (read-only)</div>
                  <p class="ei-helper">Shareable, viewable everywhere; preserves layout.</p>
                </div>
              </div>
              <a href="{{ url_for('notes.export_folder_as_pdf') }}" class="ei-action neutral">
                <i class="material-icons text-sm">picture_as_pdf</i>
                <span>Download PDF</span>
              </a>
            </div>
            <ul class="ei-bullets">
              <li>Exports MioNote, MioPages, and MioBlocks as a single PDF.</li>
              <li>Great for sharing or archiving; not re-importable.</li>
            </ul>
          </div>
        </div>

        <!-- Import Column -->
        <div class="ei-card">
          <div class="ei-card-header">
            <div>
              <div class="ei-label">Import into this folder</div>
              <p class="ei-subtext">Add new items or restore a full backup without losing hierarchy.</p>
            </div>
            <span class="ei-badge info">Guided</span>
          </div>

          <div class="ei-subcard">
            <div class="ei-subcard-head">
              <div class="flex items-center gap-2">
                <div class="ei-dot info"></div>
                <div>
                  <div class="ei-subtitle">Import individual files</div>
                  <p class="ei-helper">Create new items from common formats or JSONL exports.</p>
                </div>
              </div>
              <form action="{{ url_for('notes.import_files') }}" method="post" enctype="multipart/form-data" class="flex items-center gap-2" onsubmit="document.getElementById('importFilesSubmit').click(); return false;">
                <input type="hidden" name="target_folder_id" value="{{ current_folder_id }}">
                <input type="file" name="import_files" accept=".html,.txt,.docx,.xlsx,.jsonl" multiple style="display:none;" id="importFilesInput">
                <button type="button" class="ei-action primary" onclick="document.getElementById('importFilesInput').click()">
                  <i class="material-icons text-sm">attach_file</i>
                  <span>Select files</span>
                </button>
                <button type="submit" id="importFilesSubmit" style="display:none;"></button>
              </form>
            </div>
            <div class="ei-callout info">
              <div class="flex items-start gap-2">
                <i class="material-icons text-sm">info</i>
                <div>
                  <p class="text-xs text-blue-100 mb-1"><strong>Supports:</strong> HTML, TXT, DOCX, XLSX, JSONL (exported from MioSpace).</p>
                  <ul class="ei-bullets compact">
                    <li>Graph Workspaces (MioThink)</li>
                    <li>MioNote, MioPages, MioBlocks</li>
                    <li>MioInfinite, Markdown, Code, MioList, Diagram, Table, Blocks</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div class="ei-subcard">
            <div class="ei-subcard-head">
              <div class="flex items-center gap-2">
                <div class="ei-dot warning"></div>
                <div>
                  <div class="ei-subtitle">Import ZIP backup</div>
                  <p class="ei-helper">Restore everything exactly as exported.</p>
                </div>
              </div>
            </div>
            <form action="{{ url_for('notes.import_notes') }}" method="post" enctype="multipart/form-data" id="importForm" class="space-y-3">
              <input type="hidden" name="target_folder_id" id="target_folder_id" value="{{ current_folder_id }}">

              <div>
                <label for="import_zip" class="ei-input-label">
                  <i class="material-icons text-sm mr-1">folder_zip</i> Select backup file (.zip)
                </label>
                <input type="file" class="ei-input" id="import_zip" name="import_zip" accept=".zip" required>
                <p class="ei-helper">Choose a ZIP created from MioSpace exports.</p>
              </div>

              <div class="ei-callout muted">
                <div class="flex items-start gap-2">
                  <i class="material-icons text-sm">map</i>
                  <div>
                    <p class="text-sm text-blue-50 mb-1"><strong>Destination:</strong> This folder path is preserved during restore.</p>
                    <p class="text-xs text-blue-100">Hierarchy, images, and formatting stay intact; images are optimized automatically.</p>
                  </div>
                </div>
              </div>

              <button type="submit" class="ei-action primary w-full justify-center" id="importBtn">
                <i class="material-icons text-sm">upload</i>
                <span>Import ZIP Backup</span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

    <style>
    .export-import-shell {
      background: linear-gradient(145deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border: 1px solid var(--border-primary);
      border-radius: 14px;
      box-shadow: 0 22px 60px rgba(0,0,0,0.45);
    }
    .ei-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-primary);
    }
    .ei-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent) 0%, #0ea5e9 100%);
      display: grid;
      place-items: center;
      color: var(--bg);
      box-shadow: 0 12px 30px rgba(20, 184, 166, 0.35);
    }
    .ei-close {
      color: var(--text-secondary);
      background: transparent;
      border: none;
      padding: 8px;
      border-radius: 8px;
    }
    .ei-close:hover { background: rgba(255,255,255,0.06); color: var(--text-primary); }
    .ei-meta-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 12px 14px;
    }
    .ei-chip {
      background: rgba(20, 184, 166, 0.12);
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 12px;
      letter-spacing: 0.01em;
    }
    .ei-folder-path {
      color: var(--text-primary);
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-primary);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 13px;
    }
    .ei-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.06);
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px dashed var(--border-primary);
      font-size: 12px;
    }
    .ei-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 1024px) {
      .ei-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .ei-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 16px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .ei-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      margin-bottom: 12px;
    }
    .ei-label { color: var(--text-primary); font-weight: 700; font-size: 15px; }
    .ei-subtext { color: var(--text-secondary); font-size: 13px; margin: 4px 0 0; }
    .ei-badge {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border-primary);
    }
    .ei-badge.success { background: rgba(34,197,94,0.12); color: #4ade80; }
    .ei-badge.info { background: rgba(59,130,246,0.12); color: #93c5fd; }
    .ei-subcard {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
    }
    .ei-subcard:last-child { margin-bottom: 0; }
    .ei-subcard-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .ei-dot { width: 10px; height: 10px; border-radius: 999px; }
    .ei-dot.success { background: #4ade80; box-shadow: 0 0 0 6px rgba(74,222,128,0.15); }
    .ei-dot.info { background: #38bdf8; box-shadow: 0 0 0 6px rgba(56,189,248,0.15); }
    .ei-dot.warning { background: #fbbf24; box-shadow: 0 0 0 6px rgba(251,191,36,0.15); }
    .ei-subtitle { color: var(--text-primary); font-weight: 700; font-size: 14px; }
    .ei-helper { color: var(--text-secondary); font-size: 12px; margin: 2px 0 0; }
    .ei-bullets {
      margin: 10px 0 0;
      padding-left: 18px;
      color: var(--text-secondary);
      font-size: 12px;
      line-height: 1.6;
    }
    .ei-bullets.compact { margin-top: 6px; }
    .ei-action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 13px;
      border: 1px solid transparent;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    .ei-action.primary {
      background: linear-gradient(135deg, var(--accent) 0%, #0ea5e9 100%);
      color: var(--bg);
      box-shadow: 0 12px 30px rgba(14,165,233,0.35);
    }
    .ei-action.neutral {
      background: rgba(255,255,255,0.08);
      color: var(--text-primary);
      border-color: var(--border-primary);
    }
    .ei-action:hover { transform: translateY(-1px); box-shadow: 0 10px 26px rgba(0,0,0,0.25); }
    .ei-action:active { transform: translateY(0); }
    .ei-callout {
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
    }
    .ei-callout.info { border-color: rgba(56,189,248,0.35); background: rgba(56,189,248,0.08); }
    .ei-callout.muted { border-color: rgba(148,163,184,0.4); background: rgba(148,163,184,0.08); }
    .ei-input-label { color: var(--text-primary); font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; }
    .ei-input {
      width: 100%;
      margin-top: 6px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text-primary);
    }
    .ei-input:focus { outline: 2px solid var(--accent); border-color: var(--accent); }
    </style>

<style>
/* Carbon Teal dropdowns for switch/user menus */
.dropdown-custom {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 8px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.35);
  padding: 6px 4px;
  z-index: 11000; /* ensure dropdowns float above sticky bars and global nav content */
}
.dropdown-custom .block {
  color: var(--text-primary) !important;
}
.dropdown-custom a {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  color: var(--text-primary);
  text-decoration: none;
  border-radius: 6px;
}
.dropdown-custom a:hover {
  background: var(--hover-overlay);
}
/* Ensure utility classes from Tailwind (e.g., text-gray-700) don't override our theme */
.dropdown-custom a.text-gray-700,
.dropdown-custom a.no-underline {
  color: var(--text-primary) !important;
}

/* Style the trigger buttons to match the Carbon Teal surface */
#switchBtn, #userBtn {
  background: var(--bg-secondary) !important;
  color: var(--text-primary) !important;
  border: 1px solid var(--border-primary);
}
#switchBtn:hover, #userBtn:hover {
  background: var(--bg-tertiary) !important;
  color: var(--text-primary) !important;
}

/* MioSpace logo styling - two-tone like MioHub */
.miospace-logo {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}
.miospace-logo .mio {
  color: #ffffff;
}
.miospace-logo .space {
  color: var(--accent);
}
</style>

<script>
// Enhanced UX improvements for the import process
document.addEventListener('DOMContentLoaded', function() {
  // Handle import files input (individual files like HTML, TXT, etc.)
  const importFilesInput = document.getElementById('importFilesInput');
  if (importFilesInput) {
    importFilesInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        document.getElementById('importFilesSubmit').click();
      }
    });
  }

  const importForm = document.getElementById('importForm');
  const importBtn = document.getElementById('importBtn');
  const fileInput = document.getElementById('import_zip');
  const currentFolderBadge = document.getElementById('currentFolderBadge');
  
  // Update current folder display
  const currentFolderId = '{{ current_folder_id }}';
  // console.log('Current folder ID from template:', currentFolderId);
  
  // Update the badge with actual folder info if needed
  if (currentFolderId) {
    // The breadcrumb is already rendered in the template, so we don't need to change it here
    // console.log('Import will target folder ID:', currentFolderId);
  }
  
  // Handle form submission
  if (importForm) {
    importForm.addEventListener('submit', function(e) {
      // Ensure current folder ID is set
      const targetFolderInput = document.getElementById('target_folder_id');
      if (targetFolderInput && currentFolderId) {
        targetFolderInput.value = currentFolderId;
        console.log('Setting target folder ID to:', currentFolderId);
      }
      
      // Show loading state
      importBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Importing...';
      importBtn.disabled = true;
      
    });
  }
  
  // Handle file selection
  if (fileInput) {
    fileInput.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        console.log(`Selected file: ${file.name} (${fileSize} MB)`);
        
        // Validate file type
        if (!file.name.toLowerCase().endsWith('.zip')) {
          alert('Please select a ZIP file.');
          this.value = '';
          return;
        }
        
        // Show file info in UI (optional)
        const fileInfo = document.createElement('div');
        fileInfo.className = 'small text-muted mt-1';
        fileInfo.textContent = `Selected: ${file.name} (${fileSize} MB)`;
        
        // Remove any existing file info
        const existingInfo = this.parentNode.querySelector('.file-info');
        if (existingInfo) existingInfo.remove();
        
        fileInfo.className += ' file-info';
        this.parentNode.appendChild(fileInfo);
      }
    });
  }
  
  // Reset form when modal is closed
  const exportImportModal = document.getElementById('exportImportModal');
  if (exportImportModal) {
    // Note: We're using custom modal handling, not Bootstrap
    // Reset is handled when modal closes via closeExportImportModal()
  }
});

// Debug function to check current folder context
function debugCurrentFolder() {
  // console.log('Current folder ID:', '{{ current_folder_id }}');
  // console.log('Session current_folder_id:', '{{ session.get("current_folder_id") }}');
}

// Call debug function when page loads (remove this in production)
// debugCurrentFolder();

// Navbar dropdown move/restore/popper logic
document.addEventListener('DOMContentLoaded', function() {
  // helper: navbar dropdown move/restore/popper logic
  const hasPopper = !!(window.Popper && typeof window.Popper.createPopper === 'function');
  const menuStateMap = new Map();

  function moveMenuToBody(toggle, menu) {
    if (menuStateMap.has(menu)) return;
    if (window.MIO_DEBUG_DROPDOWNS) console.debug('moveMenuToBody called', { toggleId: toggle && toggle.id, menuId: menu && menu.id, parent: menu.parentNode && menu.parentNode.className });
    // Heuristic: only reparent to body if parent has restrictive overflow or placement would cause clipping
    const parent = menu.parentNode;
    if (parent && parent.nodeType === 1) {
      const parentStyle = window.getComputedStyle(parent);
      const hasOverflow = ['hidden', 'auto', 'scroll'].includes(parentStyle.overflow) || ['hidden', 'auto', 'scroll'].includes(parentStyle.overflowX) || ['hidden', 'auto', 'scroll'].includes(parentStyle.overflowY);
      const parentRect = parent.getBoundingClientRect();
      const spaceRight = document.documentElement.clientWidth - parentRect.left;
      let shouldReparent = hasOverflow || menu.offsetWidth > spaceRight;
      // Ensure nav-level dropdowns are reparented since sticky bars or other
      // high-z-index elements can overlap the navbar's dropdowns.
      const insideNav = toggle && !!toggle.closest && !!toggle.closest('nav');
      const insideStickyBar = parent && !!parent.closest && !!parent.closest('.folder-sticky-bar');
      if (insideNav || insideStickyBar) {
        // Force reparent
        shouldReparent = true; // eslint-disable-line no-param-reassign
      }
      if (!shouldReparent && !menu.classList.contains('dropdown-menu-end')) {
        // Parent allows visible overflow and there's ample space; skip reparenting to avoid DOM reflows
        menuStateMap.set(menu, { placeholder: null, popperInstance: null, toggle });
        return;
      }
      if (window.MIO_DEBUG_DROPDOWNS) console.debug('shouldReparent?', shouldReparent, { insideNav: insideNav, insideStickyBar: insideStickyBar, hasOverflow: hasOverflow, parentRectLeft: parentRect.left });
    }
    const placeholder = document.createElement('div');
    placeholder.className = 'dropdown-placeholder d-none';
    menu.parentNode.insertBefore(placeholder, menu);
    document.body.appendChild(menu);
    menu.style.position = 'absolute';
    menu.style.zIndex = '99999';
    // Preserve utility alignment classes so we can restore later
    menu.dataset.__orig_left0 = menu.classList.contains('left-0') ? '1' : '0';
    menu.dataset.__orig_right0 = menu.classList.contains('right-0') ? '1' : '0';
    menu.dataset.__orig_topfull = menu.classList.contains('top-full') ? '1' : '0';
    menu.dataset.__orig_bottomfull = menu.classList.contains('bottom-full') ? '1' : '0';
    menu.classList.remove('left-0', 'right-0', 'top-full', 'bottom-full');
    let popperInstance = null;
    if (hasPopper) {
      try {
        popperInstance = Popper.createPopper(toggle, menu, {
          placement: (menu.classList.contains('dropdown-menu-end') ? 'bottom-end' : 'bottom-start'),
          modifiers: [
            { name: 'offset', options: { offset: [0, 8] } },
            { name: 'preventOverflow', options: { boundary: document.documentElement, padding: 8 } },
            { name: 'flip', options: { fallbackPlacements: ['top-start', 'top-end', 'bottom-start', 'bottom-end'] } }
            , { name: 'computeStyles', options: { adaptive: false } }
          ]
        });
      } catch (e) {
        popperInstance = null;
      }
    } else {
      const rect = toggle.getBoundingClientRect();
      const topPos = rect.bottom + window.scrollY + 8;
      let leftPos;
      if (menu.classList.contains('dropdown-menu-end')) {
        leftPos = rect.right + window.scrollX - menu.offsetWidth;
      } else {
        leftPos = rect.left + window.scrollX;
      }
      const viewportLeft = window.scrollX + 8;
      const viewportRight = window.scrollX + document.documentElement.clientWidth - 8;
      leftPos = Math.max(viewportLeft, Math.min(leftPos, viewportRight - menu.offsetWidth));
      let adjustedTop = topPos;
      if (topPos + menu.offsetHeight > window.scrollY + window.innerHeight - 8) {
        adjustedTop = rect.top + window.scrollY - menu.offsetHeight - 8;
      }
      menu.style.top = adjustedTop + 'px';
      menu.style.left = leftPos + 'px';
    }
    menuStateMap.set(menu, { placeholder, popperInstance, toggle });
    if (window.MIO_DEBUG_DROPDOWNS) console.debug('menuStateMap.set', { menuId: menu && menu.id, placeholder, popperInstance });
  }

  function restoreMenuFromBody(menu) {
    const state = menuStateMap.get(menu);
    if (!state) return;
    const { placeholder, popperInstance } = state;
    if (window.MIO_DEBUG_DROPDOWNS) console.debug('restoreMenuFromBody called', { menuId: menu && menu.id });
    if (popperInstance) { try { popperInstance.destroy(); } catch (e) {} }
    if (placeholder && placeholder.parentNode) {
      placeholder.parentNode.insertBefore(menu, placeholder);
      placeholder.parentNode.removeChild(placeholder);
    }
    if (menu.dataset.__orig_left0 === '1') menu.classList.add('left-0');
    if (menu.dataset.__orig_right0 === '1') menu.classList.add('right-0');
    if (menu.dataset.__orig_topfull === '1') menu.classList.add('top-full');
    if (menu.dataset.__orig_bottomfull === '1') menu.classList.add('bottom-full');
    delete menu.dataset.__orig_left0;
    delete menu.dataset.__orig_right0;
    delete menu.dataset.__orig_topfull;
    delete menu.dataset.__orig_bottomfull;
    menu.style.position = '';
    menu.style.top = '';
    menu.style.left = '';
    menu.style.right = '';
    menu.style.bottom = '';
    menu.style.zIndex = '';
    menuStateMap.delete(menu);
  }

  // Navbar dropdowns
  const dropdowns = [
    { btn: 'switchBtn', dropdown: 'switchDropdown' },
    { btn: 'userBtn', dropdown: 'userDropdown' }
  ];
  
  dropdowns.forEach(({ btn, dropdown }) => {
    const button = document.getElementById(btn);
    const menu = document.getElementById(dropdown);
    
    if (button && menu) {
      button.setAttribute('aria-expanded','false');
      button.addEventListener('click', function(e) {
        e.stopPropagation();
        menu.classList.toggle('hidden');
        const isOpen = !menu.classList.contains('hidden');
        button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        if (isOpen) {
          moveMenuToBody(button, menu);
        } else {
          restoreMenuFromBody(menu);
        }
        // Close other dropdowns
        closeAllDropdowns([dropdown]);
      });
    }
  });
  
  // Close all dropdowns when clicking outside
  document.addEventListener('click', function() {
    closeAllDropdowns();
  });
  
  // Make closeAllDropdowns globally accessible for FAB partial
  window.closeAllDropdowns = function(except = []) {
    const allDropdowns = ['switchDropdown', 'userDropdown', 'createDropdown'];
    allDropdowns.forEach(id => {
      if (!except.includes(id)) {
        const dropdown = document.getElementById(id);
        if (dropdown) {
          dropdown.classList.add('hidden');
          const btnId = id.replace('Dropdown','Btn');
          const btn = document.getElementById(btnId);
          if (btn) btn.setAttribute('aria-expanded','false');
          try { if (typeof restoreMenuFromBody === 'function') restoreMenuFromBody(dropdown); } catch (e) {}
        }
      }
    });
  }
});

// Ensure custom nav dropdowns that toggle via CSS class do not get clipped by other stacking contexts
document.addEventListener('DOMContentLoaded', function () {
  const navDropdownIds = ['switchDropdown', 'userDropdown'];
  const hasPopper = !!(window.Popper && typeof window.Popper.createPopper === 'function');
  const menuStateMap = new Map();

    function moveMenuToBody(toggle, menu) {
    if (menuStateMap.has(menu)) return;
    const placeholder = document.createElement('div');
    placeholder.className = 'dropdown-placeholder d-none';
    menu.parentNode.insertBefore(placeholder, menu);
      document.body.appendChild(menu);
    menu.style.position = 'absolute';
    menu.style.zIndex = '99999';
      // Preserve utility alignment classes so we can restore later
      menu.dataset.__orig_left0 = menu.classList.contains('left-0') ? '1' : '0';
      menu.dataset.__orig_right0 = menu.classList.contains('right-0') ? '1' : '0';
      menu.dataset.__orig_topfull = menu.classList.contains('top-full') ? '1' : '0';
      menu.dataset.__orig_bottomfull = menu.classList.contains('bottom-full') ? '1' : '0';
      // Remove tailwind positional utilities to allow inline absolute positioning
      menu.classList.remove('left-0', 'right-0', 'top-full', 'bottom-full');
    let popperInstance = null;
    if (hasPopper) {
      try {
        popperInstance = Popper.createPopper(toggle, menu, {
          placement: (menu.classList.contains('dropdown-menu-end') ? 'bottom-end' : 'bottom-start'),
          modifiers: [
            { name: 'offset', options: { offset: [0, 8] } },
            { name: 'preventOverflow', options: { boundary: document.body } },
            { name: 'flip', options: { fallbackPlacements: ['top-start', 'top-end'] } }
          ]
        });
      } catch (e) {
        popperInstance = null;
      }
    } else {
      // simple positioning fallback
      const rect = toggle.getBoundingClientRect();
      // Prefer right aligned placement for menus with 'dropdown-menu-end'
      const topPos = rect.bottom + window.scrollY + 8;
      let leftPos;
      if (menu.classList.contains('dropdown-menu-end')) {
        // Align so right edges match (right alignment): right edge of toggle -> right edge of menu
        leftPos = rect.right + window.scrollX - menu.offsetWidth;
      } else {
        leftPos = rect.left + window.scrollX;
      }
      // Clamp within viewport so it never overflows the right/left edges
      const viewportLeft = window.scrollX + 8;
      const viewportRight = window.scrollX + document.documentElement.clientWidth - 8;
      leftPos = Math.max(viewportLeft, Math.min(leftPos, viewportRight - menu.offsetWidth));
      // If menu would overflow below the viewport, flip above toggle
      let adjustedTop = topPos;
      if (topPos + menu.offsetHeight > window.scrollY + window.innerHeight - 8) {
        adjustedTop = rect.top + window.scrollY - menu.offsetHeight - 8;
      }
      menu.style.top = adjustedTop + 'px';
      menu.style.left = leftPos + 'px';
      if (window.MIO_DEBUG_DROPDOWNS) console.log('fallback position', { rect, leftPos, adjustedTop, menuWidth: menu.offsetWidth, menuHeight: menu.offsetHeight });
    }
    menuStateMap.set(menu, { placeholder, popperInstance, toggle });
  }

  function restoreMenuFromBody(menu) {
    const state = menuStateMap.get(menu);
    if (!state) return;
    const { placeholder, popperInstance, toggle } = state;
    if (popperInstance) { try { popperInstance.destroy(); } catch (e) {} }
    if (placeholder && placeholder.parentNode) {
      placeholder.parentNode.insertBefore(menu, placeholder);
      placeholder.parentNode.removeChild(placeholder);
    }
    // Restore original utility classes if they existed
    if (menu.dataset.__orig_left0 === '1') menu.classList.add('left-0');
    if (menu.dataset.__orig_right0 === '1') menu.classList.add('right-0');
    if (menu.dataset.__orig_topfull === '1') menu.classList.add('top-full');
    if (menu.dataset.__orig_bottomfull === '1') menu.classList.add('bottom-full');
    // Remove transient dataset markers
    delete menu.dataset.__orig_left0;
    delete menu.dataset.__orig_right0;
    delete menu.dataset.__orig_topfull;
    delete menu.dataset.__orig_bottomfull;
    menu.style.position = '';
    menu.style.top = '';
    menu.style.left = '';
    menu.style.zIndex = '';
    menuStateMap.delete(menu);
  }

  // MutationObserver-based navDropdowns removed to avoid overhead.
  // We now call moveMenuToBody/restoreMenuFromBody directly in the click handlers above.
});

// Function to open combined export/import modal
function openExportImportModal() {
  const modal = document.getElementById('exportImportModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
}

// Function to close combined export/import modal
function closeExportImportModal() {
  const modal = document.getElementById('exportImportModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    
    // Reset forms
    const importForm = document.getElementById('importForm');
    if (importForm) importForm.reset();
    
    const importBtn = document.getElementById('importBtn');
    if (importBtn) {
      importBtn.innerHTML = '<i class="material-icons mr-1 text-sm">upload</i> Import ZIP Backup';
      importBtn.disabled = false;
    }
    
    // Remove any file info messages
    const fileInfos = document.querySelectorAll('.file-info');
    fileInfos.forEach(info => info.remove());
  }
}

// Function to open settings modal
function openSettingsModal() {
  const modal = document.getElementById('settingsModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
}

// Function to close settings modal
function closeSettingsModal() {
  const modal = document.getElementById('settingsModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
}

</script>

<!-- TelemetryPanel JavaScript -->
<script src="{{ url_for('static', filename='js/telemetry_panel.js') }}"></script>