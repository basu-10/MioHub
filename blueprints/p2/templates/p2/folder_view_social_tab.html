<!-- folder_view_social_tab.html -->
<!-- Social/Pinned Users Tab Content for Sidebar -->

<div class="p-2">
  <!-- My Public Page Link -->
  <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
    <a href="{{ url_for('p2_bp.view_user', user_id=current_user.id) }}" 
       class="text-white hover:text-accent" 
       style="display: flex; align-items: center; gap: 8px; text-decoration: none; font-size: 14px;">
      <span class="material-icons" style="font-size: 18px;">public</span>
      <span>My Public Page</span>
    </a>
  </div>

  <!-- Search users section -->
  <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
    <h6 class="text-muted pinned-heading" style="font-size:12px; margin:0 0 8px 0;">Search users</h6>
    <!-- Search box to find users and add them to pinned list -->
    <div class="new-folder-input" style="margin-bottom:8px;">
      <input type="search" id="sidebarUserSearch" placeholder="Search users..." aria-label="Search users">
      <!-- Clear button: clears the search field and restores the pinned users view -->
      <button id="sidebarUserClearBtn" class="cancel" title="Clear search" aria-label="Clear search" type="button" style="display:none; padding:4px 8px;">&times;</button>
      <button id="sidebarUserSearchBtn">Search</button>
    </div>

    <!-- No bulk pinning UI here; each search result has its own Pin/Unpin button -->

    <div id="sidebarSearchResults" style="padding:0; margin:0; display:none;">
      <!-- Search results injected here by JS -->
    </div>
  </div>

  <!-- Pinned users section -->
  <div id="pinnedUsersContainer" style="margin-top:0;">
    <h6 class="text-muted pinned-heading" style="font-size:12px; margin:0 0 8px 0;">Pinned users</h6>
    {% if pinned_users %}
      <ul id="pinnedUsersList" class="list-unstyled" style="padding-left:0; margin:0">
      {% for pu in pinned_users %}
        {% if pu %}
          <li data-user-id="{{ pu.id }}" class="p-1 d-flex justify-content-between align-items-center" style="padding:6px 4px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <a href="{{ url_for('p2_bp.view_user', user_id=pu.id) }}" class="text-white">{{ pu.username }}</a>
            </div>
            <form action="{{ url_for('p2_bp.toggle_pin_user', user_id=pu.id) }}" method="post" style="display:inline; margin-left: 6px;">
              <input type="hidden" name="next" value="{{ request.path }}">
              <button class="px-2 py-1 text-xs bg-yellow-500 text-black rounded">Unpin</button>
            </form>
          </li>
        {% endif %}
      {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted small">No pinned users.</div>
    {% endif %}
  </div>
</div>

<script>
// -----------------------------
// Sidebar user search and pinning
// -----------------------------
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('sidebarUserSearch');
  const searchBtn = document.getElementById('sidebarUserSearchBtn');
  const clearBtn = document.getElementById('sidebarUserClearBtn');
  const pinnedUsersContainer = document.getElementById('pinnedUsersContainer');

  if (searchBtn) {
    searchBtn.addEventListener('click', function(e){
      e.preventDefault();
      performSidebarUserSearch(searchInput.value);
    });
  }

  if (searchInput) {
    searchInput.addEventListener('keydown', function(e){
      if (e.key === 'Enter') {
        e.preventDefault();
        performSidebarUserSearch(searchInput.value);
      }
      // Support Escape to clear and restore pinned users view
      if (e.key === 'Escape' || e.key === 'Esc') {
        e.preventDefault();
        if (clearBtn) clearBtn.click();
      }
    });
    // Show/hide the clear button depending on whether there is text
    try {
      if (clearBtn) {
        clearBtn.style.display = (searchInput.value && searchInput.value.trim()) ? '' : 'none';
        searchInput.addEventListener('input', function(e){
          clearBtn.style.display = (searchInput.value && searchInput.value.trim()) ? '' : 'none';
        });
        clearBtn.addEventListener('click', function(e){
          e.preventDefault();
          // Clear the field and restore the pinned users view
          searchInput.value = '';
          // Trigger the search handler (this will hide results) and then ensure pinned users are visible
          try { performSidebarUserSearch(''); } catch (err) { /* ignore if unavailable */ }
          const resultsDiv = document.getElementById('sidebarSearchResults');
          const pinnedDiv = document.getElementById('pinnedUsersContainer');
          if (resultsDiv) resultsDiv.style.display = 'none';
          if (pinnedDiv) pinnedDiv.style.display = '';
          searchInput.focus();
        });
      }
    } catch (err) {
      console.warn('Clear button handler setup failed', err);
    }
  }

  // Intercept unpin forms in the pinned users list to use AJAX instead of full-page POST
  const pinnedList = document.getElementById('pinnedUsersList');
  if (pinnedList) {
    pinnedList.addEventListener('submit', function(e){
      try {
        e.preventDefault();
        const form = e.target;
        // Extract user id from action URL like /users/<id>/toggle_pin
        const match = form.action && form.action.match(/\/users\/(\d+)\/toggle_pin/);
        if (match) {
          const userId = parseInt(match[1]);
          const li = form.closest('li');
          const btn = form.querySelector('button');
          togglePinFromSidebar(userId, li, btn);
        } else {
          // fallback: perform default submit
          form.submit();
        }
      } catch (err) {
        console.error('Pinned list intercept failed', err);
      }
    });
  }
});

async function performSidebarUserSearch(q) {
  const resultsDiv = document.getElementById('sidebarSearchResults');
  if (!q || !q.trim()) {
    // If empty: just hide search results and show pinned users (already visible below)
    const existingResults = resultsDiv.querySelectorAll('.sidebar-search-result');
    if (existingResults && existingResults.length) {
      existingResults.forEach(el => el.remove());
    }
    // show pinned users (already in DOM from server): ensure search results container hidden
    if (resultsDiv) resultsDiv.style.display = 'none';
    if (pinnedUsersContainer) pinnedUsersContainer.style.display = '';
    return;
  }

  const url = `/users/api/search?q=${encodeURIComponent(q)}`;
  console.log('[sidebar] Searching users via JSON API:', url);
  try {
    const resp = await fetch(url, { credentials: 'same-origin' });
    const data = await resp.json();
    if (data && data.success) {
      console.log('[sidebar] JSON search results:', data.users?.length || 0);
      renderSidebarSearchResultsFromJson(data.users);
    } else {
      renderSidebarSearchResultsFromJson([]);
    }
    // show search results container and hide pinned users list temporarily
    if (resultsDiv) resultsDiv.style.display = '';
    if (pinnedUsersContainer) pinnedUsersContainer.style.display = 'none';
  } catch (e) {
    console.error('Sidebar user search failed:', e);
  }
}

function renderSidebarSearchResultsFromJson(users) {
  const resultsDiv = document.getElementById('sidebarSearchResults');
  let resultsList = document.getElementById('sidebarSearchResultsList');
  if (!resultsList) {
    resultsList = document.createElement('ul');
    resultsList.id = 'sidebarSearchResultsList';
    resultsList.className = 'list-unstyled';
    resultsList.style.paddingLeft = '0';
    resultsList.style.margin = '8px 0 0 0';
    resultsDiv.insertAdjacentElement('afterbegin', resultsList);
  }
  resultsList.innerHTML = '';

  let total = 0;
  for (let u of users || []) {
    const id = u.id;
    const username = u.username || 'User';
    const pinned = !!u.pinned;
    total += 1;

    const newLi = document.createElement('li');
    newLi.className = 'p-1 sidebar-search-result d-flex justify-content-between align-items-center';
    newLi.style.padding = '6px 4px';
    newLi.dataset.userId = id;
    newLi.dataset.pinned = pinned ? '1' : '0';

    const leftDiv = document.createElement('div');
    leftDiv.style.display = 'flex';
    leftDiv.style.alignItems = 'center';
    leftDiv.style.gap = '8px';

    const link = document.createElement('a');
    link.href = `/users/${id}`;
    link.className = 'text-white';
    link.textContent = username;
    leftDiv.appendChild(link);

    const rightDiv = document.createElement('div');
    rightDiv.style.display = 'flex';
    rightDiv.style.gap = '6px';
    const pinBtn = document.createElement('button');
    pinBtn.className = 'px-2 py-1 text-xs rounded';
    pinBtn.dataset.userId = id;
    pinBtn.textContent = pinned ? 'Unpin' : 'Pin';
    if (pinned) {
      pinBtn.classList.add('bg-yellow-500');
      pinBtn.classList.add('text-black');
    } else {
      pinBtn.classList.add('bg-yellow-600');
      pinBtn.classList.add('text-white');
    }
    pinBtn.addEventListener('click', function(e){
      e.preventDefault();
      togglePinFromSidebar(id, newLi, pinBtn);
    });
    rightDiv.appendChild(pinBtn);

    newLi.appendChild(leftDiv);
    newLi.appendChild(rightDiv);
    resultsList.appendChild(newLi);
  }

  // Show / hide depending on results
  if (total > 0) {
    if (resultsDiv) resultsDiv.style.display = '';
    const pinnedUsersContainer = document.getElementById('pinnedUsersContainer');
    if (pinnedUsersContainer) pinnedUsersContainer.style.display = 'none';
  } else {
    if (resultsDiv) resultsDiv.style.display = 'none';
    const pinnedUsersContainer = document.getElementById('pinnedUsersContainer');
    if (pinnedUsersContainer) pinnedUsersContainer.style.display = '';
    const msg = document.createElement('div');
    msg.className = 'text-muted small';
    msg.textContent = 'No users found.';
    resultsList.appendChild(msg);
  }
}

async function togglePinFromSidebar(userId, containerEl, buttonEl) {
  try {
    const response = await fetch(`/users/${userId}/toggle_pin_ajax`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    const body = await response.json();
    if (body && body.success) {
      const pinned = !!body.pinned;
      containerEl.dataset.pinned = pinned ? '1' : '0';
      buttonEl.textContent = pinned ? 'Unpin' : 'Pin';
      if (pinned) {
        buttonEl.classList.remove('bg-yellow-600');
        buttonEl.classList.remove('text-white');
        buttonEl.classList.add('bg-yellow-500');
        buttonEl.classList.add('text-black');
      } else {
        buttonEl.classList.remove('bg-yellow-500');
        buttonEl.classList.remove('text-black');
        buttonEl.classList.add('bg-yellow-600');
        buttonEl.classList.add('text-white');
      }
      // Update the top pinned users list to keep UI in sync
      const pinnedList = document.getElementById('pinnedUsersList');
      if (pinnedList) {
        if (pinned) {
          // Add to pinned list if not present
          if (!pinnedList.querySelector(`li[data-user-id='${userId}']`)) {
            const li = document.createElement('li');
            li.className = 'p-1 d-flex justify-content-between align-items-center';
            li.style.padding = '6px 4px';
            li.dataset.userId = userId;
            // attempt to preserve username from the search result item
            const usernameLabel = (containerEl ? ( (containerEl.querySelector('a') && containerEl.querySelector('a').textContent) || 'User' ) : 'User');
            li.innerHTML = `<div style='display:flex; align-items:center; gap:8px;'><a href='/users/${userId}' class='text-white'>${usernameLabel}</a></div><form action='/users/${userId}/toggle_pin' method='post' style='display:inline; margin-left:6px;'><button class='px-2 py-1 text-xs bg-yellow-500 text-black rounded'>Unpin</button></form>`;
            pinnedList.appendChild(li);
          }
        } else {
          // Remove from pinned list
          const existing = pinnedList.querySelector(`li[data-user-id='${userId}']`);
          if (existing) existing.remove();
        }
      }
    } else {
      alert(body && body.message ? body.message : 'Failed to toggle pin');
    }
  } catch (e) {
    console.error('togglePinFromSidebar error:', e);
    alert('Error updating pinned status');
  }
}
</script>
