<!-- Persistent Options Sidebar -->
<div id="persistentOptionsSidebar" class="persistent-options-sidebar">
  <button id="sidebarExpandToggle" class="sidebar-expand-toggle" type="button" aria-label="Toggle sidebar width">
    <i class="material-icons">chevron_right</i>
  </button>

  <div class="sidebar-group" aria-label="Sorting and View Controls">
    <!-- Sort Option -->
    <div class="sidebar-option-item" id="sidebarSortOption">
      <button class="sidebar-option-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Sort">
        <i class="material-icons">sort</i>
        <span class="sidebar-option-label">Sort</span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="sidebarSortOption">
        <li><a class="dropdown-item{% if current_sort == 'name' %} active{% endif %}" href="{{ url_for('folders.view_folder', folder_id=folder.id, sort='name') }}">Name</a></li>
        <li><a class="dropdown-item{% if current_sort == 'created' %} active{% endif %}" href="{{ url_for('folders.view_folder', folder_id=folder.id, sort='created') }}">Created</a></li>
        <li><a class="dropdown-item{% if current_sort == 'modified' %} active{% endif %}" href="{{ url_for('folders.view_folder', folder_id=folder.id, sort='modified') }}">Last Modified</a></li>
        <li><a class="dropdown-item{% if current_sort == 'size' %} active{% endif %}" href="{{ url_for('folders.view_folder', folder_id=folder.id, sort='size') }}">Size</a></li>
      </ul>
    </div>

    <!-- View Option -->
    <div class="sidebar-option-item" id="sidebarViewOption">
      <button class="sidebar-option-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="View Settings">
        <i class="material-icons">view_module</i>
        <span class="sidebar-option-label">View</span>
      </button>
      <div class="dropdown-menu dropdown-menu-end p-3" aria-labelledby="sidebarViewOption" style="min-width: 280px;" onclick="event.stopPropagation();">
        <h6 class="dropdown-header px-0 mb-2">Display Settings</h6>

        <!-- View Mode -->
        <div class="mb-3">
          <label class="form-label small mb-1" style="color: var(--white);">View Mode</label>
          <div class="btn-group btn-group-sm w-100" role="group">
            <input type="radio" class="btn-check" name="sidebarViewMode" id="sidebarViewGrid" value="grid" {% if display_prefs.view_mode == 'grid' %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarViewGrid">
              <i class="material-icons" style="font-size: 14px;">grid_view</i> Grid
            </label>
            
            <input type="radio" class="btn-check" name="sidebarViewMode" id="sidebarViewList" value="list" {% if display_prefs.view_mode == 'list' %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarViewList">
              <i class="material-icons" style="font-size: 14px;">view_list</i> List
            </label>
          </div>
        </div>

        <!-- Grid-only Options (Columns, Card Size, Previews) -->
        <div id="sidebarGridOptionsContainer" class="grid-options {% if display_prefs.view_mode != 'grid' %}d-none{% endif %}">
        <!-- Column Count -->
        <div class="mb-3">
          <label class="form-label small mb-1" style="color: var(--white);">Columns</label>
          <div class="btn-group btn-group-sm w-100" role="group">
            <input type="radio" class="btn-check" name="sidebarColumnCount" id="sidebarCol1" value="1" {% if display_prefs.columns == 1 %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarCol1">1</label>
            
            <input type="radio" class="btn-check" name="sidebarColumnCount" id="sidebarCol2" value="2" {% if display_prefs.columns == 2 %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarCol2">2</label>
            
            <input type="radio" class="btn-check" name="sidebarColumnCount" id="sidebarCol3" value="3" {% if display_prefs.columns == 3 %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarCol3">3</label>
            
            <input type="radio" class="btn-check" name="sidebarColumnCount" id="sidebarCol4" value="4" {% if display_prefs.columns == 4 %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarCol4">4</label>
            
            <input type="radio" class="btn-check" name="sidebarColumnCount" id="sidebarCol5" value="5" {% if display_prefs.columns == 5 %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarCol5">5</label>
            
            <input type="radio" class="btn-check" name="sidebarColumnCount" id="sidebarCol6" value="6" {% if display_prefs.columns == 6 %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarCol6">6</label>
          </div>
        </div>

        <!-- Card Size -->
        <div class="mb-3">
          <label class="form-label small mb-1" style="color: var(--white);">Card Size</label>
          <div class="btn-group btn-group-sm w-100" role="group">
            <input type="radio" class="btn-check" name="sidebarCardSize" id="sidebarSizeCompact" value="compact" {% if display_prefs.card_size == 'compact' %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarSizeCompact">Compact</label>
            
            <input type="radio" class="btn-check" name="sidebarCardSize" id="sidebarSizeNormal" value="normal" {% if display_prefs.card_size == 'normal' %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarSizeNormal">Normal</label>
            
            <input type="radio" class="btn-check" name="sidebarCardSize" id="sidebarSizeLarge" value="large" {% if display_prefs.card_size == 'large' %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="sidebarSizeLarge">Large</label>
          </div>
        </div>

        <!-- Show Previews Toggle -->
        <div class="mb-2">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="sidebarShowPreviews" {% if display_prefs.show_previews %}checked{% endif %}>
            <label class="form-check-label small" for="sidebarShowPreviews" style="color: var(--white);">
              Show content previews
            </label>
          </div>
        </div>
        </div>

        <hr class="my-2">
        <div class="small" style="color: var(--white);">
          <i class="material-icons" style="font-size: 12px;">info</i>
          Settings are saved to your account
        </div>
      </div>
    </div>
  </div>

  <div class="sidebar-group" aria-label="Public Links">
    <!-- Go to Public Page -->
    <div class="sidebar-option-item">
      <a href="{{ url_for('p2_bp.view_user', user_id=current_user.id) }}" class="sidebar-option-btn" title="View My Public Profile">
        <i class="material-icons">public</i>
        <span class="sidebar-option-label">Public</span>
      </a>
    </div>
  </div>

  <div class="sidebar-group sidebar-social-section" aria-label="User Search and Pins">
    <div class="sidebar-group-title">Users</div>

    <div class="sidebar-social-search">
      <label class="visually-hidden" for="sidebarUserSearchCompact">Search users</label>
      <div class="sidebar-social-input">
        <input type="search" id="sidebarUserSearchCompact" placeholder="Search users..." aria-label="Search users">
        <button id="sidebarUserClearBtnCompact" class="cancel" title="Clear search" aria-label="Clear search" type="button" style="display:none;">&times;</button>
        <button id="sidebarUserSearchBtnCompact" type="button">Search</button>
      </div>
      <div id="sidebarSearchResultsCompact" class="sidebar-social-results" style="display:none;"></div>
    </div>

    <div id="sidebarPinnedUsersContainerCompact" class="sidebar-social-pinned">
      <h6 class="text-muted pinned-heading" style="font-size:12px; margin:0 0 8px 0;">Pinned users</h6>
      {% if pinned_users %}
        <ul id="sidebarPinnedUsersListCompact" class="list-unstyled" style="padding-left:0; margin:0">
        {% for pu in pinned_users %}
          {% if pu %}
            <li data-user-id="{{ pu.id }}" class="p-1 d-flex justify-content-between align-items-center" style="padding:6px 4px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <a href="{{ url_for('p2_bp.view_user', user_id=pu.id) }}" class="text-white">{{ pu.username }}</a>
              </div>
              <form action="{{ url_for('p2_bp.toggle_pin_user', user_id=pu.id) }}" method="post" style="display:inline; margin-left: 6px;">
                <input type="hidden" name="next" value="{{ request.path }}">
                <button class="px-2 py-1 text-xs bg-yellow-500 text-black rounded">Unpin</button>
              </form>
            </li>
          {% endif %}
        {% endfor %}
        </ul>
      {% else %}
        <div class="text-muted small">No pinned users.</div>
      {% endif %}
    </div>
  </div>

  <div class="sidebar-bottom" aria-label="Tutorial and account controls">
    <div class="sidebar-option-item">
      <button id="sidebarTutorialBtn" class="sidebar-option-btn" type="button" title="Tutorial" onclick="if (typeof window.startTutorial === 'function') window.startTutorial();">
        <i class="material-icons">help_outline</i>
        <span class="sidebar-option-label">Tutorial</span>
      </button>
    </div>

    <div class="sidebar-account-row">
      <div class="sidebar-option-item">
        <a href="{{ url_for('p2_bp.profile') }}" class="sidebar-option-btn" title="Profile">
          <i class="material-icons">person</i>
          <span class="sidebar-option-label">Profile</span>
        </a>
      </div>
      <div class="sidebar-option-item dropdown">
        <button class="sidebar-option-btn sidebar-account-caret" type="button" id="sidebarAccountDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Account menu">
          <i class="material-icons">expand_more</i>
          <span class="sidebar-option-label">Account</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end sidebar-account-dropdown-menu" aria-labelledby="sidebarAccountDropdown">
          <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); if (typeof openSettingsModal === 'function') openSettingsModal();">Settings</a></li>
          <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); if (typeof openExportImportModal === 'function') openExportImportModal();">Export/Import</a></li>
          <li><a class="dropdown-item" href="{{ url_for('p2_bp.logout') }}">Logout</a></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Sidebar Styles -->
<style>
.persistent-options-sidebar {
  position: fixed;
  left: 0;
  top: 70px; /* flush under navbar */
  width: 60px;
  height: calc(100vh - 70px);
  background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  border-right: 1px solid var(--border-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0.6rem 0.4rem;
  gap: 0.5rem;
  z-index: 900;
  box-shadow: 2px 0 8px rgba(0,0,0,0.3);
  transition: width 0.25s ease, padding 0.25s ease;
}

.persistent-options-sidebar.expanded {
  width: 220px;
  align-items: stretch;
  padding: 0.8rem 0.75rem;
  gap: 0.75rem;
}

.sidebar-expand-toggle {
  width: 44px;
  height: 44px;
  border-radius: 10px;
  border: 1px solid var(--border-primary);
  background: rgba(255,255,255,0.03);
  color: var(--muted);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  transition: all 0.2s ease;
}

.persistent-options-sidebar.expanded .sidebar-expand-toggle {
  margin-left: 0;
  width: 100%;
  justify-content: flex-start;
  padding-left: 0.4rem;
}

.sidebar-expand-toggle:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: rgba(20, 184, 166, 0.08);
}

.sidebar-group {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: 0.4rem 0;
  border-top: 1px solid rgba(255,255,255,0.06);
}

.sidebar-group:first-of-type {
  border-top: none;
  padding-top: 0;
}

.sidebar-option-item {
  position: relative;
  width: 100%;
  display: flex;
  justify-content: center;
}

.sidebar-option-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  border-radius: 10px;
  background: transparent;
  border: 1px solid transparent;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  padding: 0.25rem;
}

.persistent-options-sidebar.expanded .sidebar-option-btn {
  flex-direction: row;
  justify-content: flex-start;
  width: 100%;
  height: 48px;
  padding: 0.55rem 0.6rem;
  gap: 0.6rem;
}

.sidebar-option-btn:hover {
  background: rgba(20, 184, 166, 0.1);
  border-color: var(--accent);
  color: var(--accent);
}

.sidebar-option-btn .material-icons {
  font-size: 20px;
  margin-bottom: 2px;
}

.persistent-options-sidebar.expanded .sidebar-option-btn .material-icons {
  margin-bottom: 0;
}

.sidebar-option-label {
  font-size: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  line-height: 1;
}

.persistent-options-sidebar.expanded .sidebar-option-label {
  font-size: 12px;
  letter-spacing: 0.3px;
}

/* Adjust main content to account for sidebar */
#mainContent {
  margin-left: 60px !important;
  width: calc(100% - 60px);
  max-width: calc(100% - 60px);
  box-sizing: border-box;
  transition: margin-left 0.25s ease;
}

#mainContent.persistent-sidebar-expanded {
  margin-left: 220px !important;
  width: calc(100% - 220px);
  max-width: calc(100% - 220px);
}

/* Mobile: hide sidebar, restore original layout */
@media (max-width: 768px) {
  .persistent-options-sidebar {
    display: none;
  }
  #mainContent {
    margin-left: 0 !important;
    width: 100%;
    max-width: 100%;
    padding-left: 0.75rem !important;
    padding-right: 0.75rem !important;
    padding-bottom: 90px !important; /* leave room for bottom nav */
  }
}

/* Mobile Bottom Nav + Sheets */
.mobile-bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 64px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-primary);
  display: none;
  align-items: center;
  justify-content: space-around;
  padding: 0 6px;
  z-index: 1100;
  box-shadow: 0 -6px 18px rgba(0,0,0,0.35);
}

.mobile-bottom-nav button {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  height: 52px;
  border-radius: 12px;
  font-size: 12px;
}

.mobile-bottom-nav .mobile-nav-btn.wide,
.mobile-bottom-nav .mobile-nav-btn.wide-people {
  flex: 1.1;
}

.mobile-bottom-nav button.active,
.mobile-bottom-nav button:focus-visible,
.mobile-bottom-nav button:hover {
  background: rgba(20,184,166,0.12);
  color: var(--accent);
}

.mobile-bottom-nav .material-icons {
  font-size: 22px;
}

.mobile-nav-combo {
  position: relative;
}

.mobile-nav-flyout {
  position: absolute;
  left: 50%;
  bottom: 62px;
  transform: translateX(-50%);
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 12px;
  box-shadow: 0 -6px 18px rgba(0,0,0,0.35);
  padding: 8px;
  display: none;
  gap: 8px;
  min-width: 200px;
  z-index: 1102;
}

.mobile-nav-flyout.show {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.mobile-flyout-btn {
  border-radius: 10px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-primary);
  color: var(--text-primary);
  padding: 10px 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 13px;
}

.mobile-flyout-btn:hover,
.mobile-flyout-btn:focus-visible {
  background: rgba(20,184,166,0.12);
  color: var(--accent);
}

.mobile-bottom-sheet-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 1099;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.mobile-bottom-sheet-backdrop.show {
  opacity: 1;
  pointer-events: auto;
}

.mobile-bottom-sheet {
  position: fixed;
  left: 0;
  right: 0;
  bottom: -320px;
  background: var(--bg-secondary);
  border-top-left-radius: 18px;
  border-top-right-radius: 18px;
  border: 1px solid var(--border-primary);
  box-shadow: 0 -8px 28px rgba(0,0,0,0.45);
  z-index: 1101;
  padding: 14px 16px 18px 16px;
  max-height: 320px;
  overflow-y: auto;
  transition: transform 0.22s ease, bottom 0.22s ease;
  transform: translateY(0);
}

.mobile-bottom-sheet.show {
  bottom: 0;
}

.mobile-sheet-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.mobile-sheet-header h6 {
  margin: 0;
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 600;
}

.mobile-sheet-close {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border-radius: 10px;
}

.mobile-sheet-close:hover {
  background: var(--hover-overlay);
  color: var(--accent);
}

.mobile-sheet-section {
  border: 1px solid var(--border-primary);
  border-radius: 12px;
  padding: 10px 12px;
  margin-bottom: 10px;
  background: var(--bg-tertiary);
}

.mobile-sheet-section h5 {
  font-size: 13px;
  margin: 0 0 8px 0;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.mobile-sheet-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 8px;
}

.mobile-sheet-actions .btn {
  width: 100%;
  justify-content: center;
}

.mobile-pill-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.mobile-pill {
  border: 1px solid var(--border-primary);
  background: var(--bg-quaternary);
  color: var(--text-primary);
  padding: 6px 10px;
  border-radius: 10px;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

@media (max-width: 768px) {
  .mobile-bottom-nav { display: flex; }
  .mobile-bottom-sheet { display: block; }
  .mobile-bottom-sheet-backdrop { display: block; }
}

@media (min-width: 769px) {
  .mobile-bottom-nav,
  .mobile-bottom-sheet,
  .mobile-bottom-sheet-backdrop {
    display: none !important;
  }
}

/* Dropdown positioning for sidebar */
.sidebar-option-item .dropdown-menu {
  left: 100% !important;
  top: 0 !important;
  margin-left: 0.5rem;
}

.persistent-options-sidebar.expanded .sidebar-option-item .dropdown-menu {
  left: calc(100% + 8px) !important;
}

.sidebar-group-title {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.6px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 6px;
}

.sidebar-social-section {
  display: none;
}

.persistent-options-sidebar.expanded .sidebar-social-section {
  display: block;
}

.sidebar-social-input {
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 6px;
  align-items: center;
}

.sidebar-social-input input[type="search"] {
  width: 100%;
  padding: 6px 8px;
  border-radius: 8px;
  border: 1px solid var(--border-primary);
  background: rgba(255,255,255,0.04);
  color: var(--white);
}

.sidebar-social-input button {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid var(--border-primary);
  background: rgba(255,255,255,0.06);
  color: var(--white);
  transition: all 0.2s ease;
}

.sidebar-social-input button:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.sidebar-social-results, .sidebar-social-pinned {
  margin-top: 10px;
}

.sidebar-social-results ul, .sidebar-social-pinned ul {
  max-height: 260px;
  overflow-y: auto;
}

.sidebar-bottom {
  margin-top: auto;
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: 0.4rem 0 0.2rem 0;
  border-top: 1px solid rgba(255,255,255,0.06);
}

.sidebar-account-row {
  display: flex;
  gap: 0.4rem;
  justify-content: center;
  width: 100%;
}

.persistent-options-sidebar:not(.expanded) .sidebar-account-row {
  flex-direction: column;
  align-items: center;
}

.persistent-options-sidebar.expanded .sidebar-account-row .sidebar-option-btn {
  width: 100%;
  justify-content: flex-start;
}

.sidebar-account-row .dropdown-menu {
  min-width: 220px;
  background: var(--bg-secondary) !important;
  border: 1px solid var(--border-primary);
  box-shadow: 0 12px 28px rgba(0,0,0,0.5);
  opacity: 1;
  z-index: 10000;
  padding: 0.5rem 0;
}

.sidebar-account-row .dropdown-item {
  color: var(--text-primary) !important;
  padding: 0.5rem 1rem;
  transition: background 0.2s ease;
}

.sidebar-account-row .dropdown-item:hover {
  background: var(--hover-overlay) !important;
  color: var(--accent) !important;
}
</style>

<!-- Mobile Bottom Navigation + Sheets -->
<div class="mobile-bottom-sheet-backdrop" id="mobileSheetBackdrop" aria-hidden="true"></div>

<div class="mobile-bottom-sheet" id="mobileSortSheet" role="dialog" aria-modal="true" aria-label="Sort options">
  <div class="mobile-sheet-header">
    <h6>Sort</h6>
    <button class="mobile-sheet-close" type="button" data-sheet-close aria-label="Close sort sheet"><i class="material-icons">close</i></button>
  </div>
  <div class="mobile-sheet-section">
    <div class="mobile-sheet-actions">
      <a class="btn btn-outline-primary" href="{{ url_for('folders.view_folder', folder_id=folder.id, sort='name') }}">Name</a>
      <a class="btn btn-outline-primary" href="{{ url_for('folders.view_folder', folder_id=folder.id, sort='created') }}">Created</a>
      <a class="btn btn-outline-primary" href="{{ url_for('folders.view_folder', folder_id=folder.id, sort='modified') }}">Last Modified</a>
      <a class="btn btn-outline-primary" href="{{ url_for('folders.view_folder', folder_id=folder.id, sort='size') }}">Size</a>
    </div>
  </div>
</div>

<div class="mobile-bottom-sheet" id="mobileViewSheet" role="dialog" aria-modal="true" aria-label="View settings">
  <div class="mobile-sheet-header">
    <h6>View</h6>
    <button class="mobile-sheet-close" type="button" data-sheet-close aria-label="Close view sheet"><i class="material-icons">close</i></button>
  </div>
  <div class="mobile-sheet-section">
    <h5>Mode</h5>
    <div class="mobile-pill-list" id="mobileViewModePills">
      <button class="mobile-pill" type="button" data-view-mode="grid"><i class="material-icons">grid_view</i>Grid</button>
      <button class="mobile-pill" type="button" data-view-mode="list"><i class="material-icons">view_list</i>List</button>
    </div>
  </div>
  <div class="mobile-sheet-section" id="mobileGridOptions">
    <h5>Grid Columns</h5>
    <div class="mobile-pill-list" id="mobileColumnPills">
      {% for col in range(1,7) %}
      <button class="mobile-pill" type="button" data-column-count="{{ col }}">{{ col }}</button>
      {% endfor %}
    </div>
  </div>
  <div class="mobile-sheet-section">
    <h5>Card Size</h5>
    <div class="mobile-pill-list" id="mobileCardSizePills">
      <button class="mobile-pill" type="button" data-card-size="compact">Compact</button>
      <button class="mobile-pill" type="button" data-card-size="normal">Normal</button>
      <button class="mobile-pill" type="button" data-card-size="large">Large</button>
    </div>
  </div>
  <div class="mobile-sheet-section">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="mobileShowPreviews">
      <label class="form-check-label" for="mobileShowPreviews">Show content previews</label>
    </div>
  </div>
</div>

<div class="mobile-bottom-sheet" id="mobileCreateSheet" role="dialog" aria-modal="true" aria-label="Create new content">
  <div class="mobile-sheet-header">
    <h6>Create</h6>
    <button class="mobile-sheet-close" type="button" data-sheet-close aria-label="Close create sheet"><i class="material-icons">close</i></button>
  </div>
  <div class="mobile-sheet-section">
    <h5>Quick create</h5>
    <div class="mobile-sheet-actions">
      <button class="btn btn-outline-primary" type="button" onclick="openCreateFolderModal()"><i class="material-icons me-1">folder</i>Folder</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewNote()"><i class="material-icons me-1">description</i>MioNote</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewBoard()"><i class="material-icons me-1">dashboard</i>MioPages</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewCombined()"><i class="material-icons me-1">article</i>MioBlocks</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewFile('proprietary_graph')"><i class="material-icons me-1">device_hub</i>MioThink</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewInfiniteBoard()"><i class="material-icons me-1">explore</i>MioInfinite</button>
    </div>
  </div>
  <div class="mobile-sheet-section">
    <h5>Other types</h5>
    <div class="mobile-sheet-actions">
      <button class="btn btn-outline-primary" type="button" onclick="createNewFile('markdown')"><i class="material-icons me-1">text_fields</i>Markdown</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewFile('code')"><i class="material-icons me-1">code</i>Code</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewFile('table')"><i class="material-icons me-1">table_chart</i>Table</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewFile('blocks')"><i class="material-icons me-1">view_week</i>Blocks</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewFile('diagram')"><i class="material-icons me-1">account_tree</i>Diagram</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewFile('timeline')"><i class="material-icons me-1">timeline</i>MioEvents</button>
      <button class="btn btn-outline-primary" type="button" onclick="createNewFile('todo')"><i class="material-icons me-1">checklist</i>MioList</button>
    </div>
  </div>
</div>

<div class="mobile-bottom-sheet" id="mobilePeopleSheet" role="dialog" aria-modal="true" aria-label="Search and pinned users">
  <div class="mobile-sheet-header">
    <h6>People</h6>
    <button class="mobile-sheet-close" type="button" data-sheet-close aria-label="Close people sheet"><i class="material-icons">close</i></button>
  </div>
  <div class="mobile-sheet-section">
    <h5>Search</h5>
    <div class="mobile-pill-list" style="flex-direction: column; gap: 8px;">
      <div class="sidebar-social-input">
        <input type="search" id="mobileUserSearch" placeholder="Search users..." aria-label="Search users">
        <button id="mobileUserClearBtn" class="cancel" title="Clear search" aria-label="Clear search" type="button" style="display:none;">&times;</button>
        <button id="mobileUserSearchBtn" type="button">Search</button>
      </div>
      <div id="mobileSearchResults" class="sidebar-social-results" style="display:none;"></div>
    </div>
  </div>
  <div class="mobile-sheet-section" id="mobilePinnedUsersContainer">
    <h5>Pinned</h5>
    {% if pinned_users %}
      <ul id="mobilePinnedUsersList" class="list-unstyled" style="padding-left:0; margin:0;">
      {% for pu in pinned_users %}
        {% if pu %}
        <li data-user-id="{{ pu.id }}" class="p-1 d-flex justify-content-between align-items-center" style="padding:6px 4px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <a href="{{ url_for('p2_bp.view_user', user_id=pu.id) }}" class="text-white">{{ pu.username }}</a>
          </div>
          <form action="{{ url_for('p2_bp.toggle_pin_user', user_id=pu.id) }}" method="post" style="display:inline; margin-left: 6px;">
            <input type="hidden" name="next" value="{{ request.path }}">
            <button class="px-2 py-1 text-xs bg-yellow-500 text-black rounded">Unpin</button>
          </form>
        </li>
        {% endif %}
      {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted small">No pinned users.</div>
    {% endif %}
  </div>
</div>

<div class="mobile-bottom-sheet" id="mobileMoreSheet" role="dialog" aria-modal="true" aria-label="More actions">
  <div class="mobile-sheet-header">
    <h6>More</h6>
    <button class="mobile-sheet-close" type="button" data-sheet-close aria-label="Close more sheet"><i class="material-icons">close</i></button>
  </div>
  <div class="mobile-sheet-section mobile-sheet-actions">
    <a class="btn btn-outline-primary" href="{{ url_for('p2_bp.view_user', user_id=current_user.id) }}"><i class="material-icons me-1">public</i>Public</a>
    <button class="btn btn-outline-primary" type="button" onclick="if (typeof window.scrollTo === 'function') window.scrollTo({top:0,behavior:'smooth'});"><i class="material-icons me-1">vertical_align_top</i>Top</button>
    <button class="btn btn-outline-primary" type="button" onclick="if (typeof window.startTutorial === 'function') window.startTutorial();"><i class="material-icons me-1">help_outline</i>Tutorial</button>
    <a class="btn btn-outline-primary" href="{{ url_for('p2_bp.profile') }}"><i class="material-icons me-1">person</i>Profile</a>
    <button class="btn btn-outline-primary" type="button" onclick="if (typeof openSettingsModal === 'function') openSettingsModal();"><i class="material-icons me-1">settings</i>Settings</button>
    <button class="btn btn-outline-primary" type="button" onclick="if (typeof openExportImportModal === 'function') openExportImportModal();"><i class="material-icons me-1">folder_shared</i>Export/Import</button>
    <a class="btn btn-outline-danger" href="{{ url_for('p2_bp.logout') }}"><i class="material-icons me-1">logout</i>Logout</a>
  </div>
</div>

<nav class="mobile-bottom-nav" aria-label="Mobile navigation">
  <div class="mobile-nav-combo">
    <button type="button" class="mobile-nav-btn" id="mobileLayoutToggle">
      <i class="material-icons" aria-hidden="true">tune</i>
      <span>Layout</span>
    </button>
    <div class="mobile-nav-flyout" id="mobileLayoutFlyout">
      <button type="button" class="mobile-flyout-btn" data-sheet-target="mobileSortSheet">
        <i class="material-icons" aria-hidden="true">sort</i>
        <span>Sort</span>
      </button>
      <button type="button" class="mobile-flyout-btn" data-sheet-target="mobileViewSheet">
        <i class="material-icons" aria-hidden="true">view_module</i>
        <span>View</span>
      </button>
    </div>
  </div>
  <button type="button" class="mobile-nav-btn wide-people" data-sheet-target="mobilePeopleSheet">
    <i class="material-icons" aria-hidden="true">group</i>
    <span>People</span>
  </button>
  <button type="button" class="mobile-nav-btn wide" data-sheet-target="mobileCreateSheet">
    <i class="material-icons" aria-hidden="true">add_circle</i>
    <span>Create</span>
  </button>
  <button type="button" class="mobile-nav-btn" data-sheet-target="mobileMoreSheet">
    <i class="material-icons" aria-hidden="true">more_horiz</i>
    <span>More</span>
  </button>
</nav>

<!-- Sidebar Functionality Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const sidebar = document.getElementById('persistentOptionsSidebar');
  const mainContent = document.getElementById('mainContent');
  const expandToggle = document.getElementById('sidebarExpandToggle');
  const socialSection = document.querySelector('.sidebar-social-section');

  // Keep the account dropdown visible even near viewport edges.
  (function initSidebarAccountDropdownAutoPositioning() {
    const toggle = document.getElementById('sidebarAccountDropdown');
    if (!toggle) return;

    const dropdown = toggle.closest('.dropdown');
    const menu = dropdown ? dropdown.querySelector('.sidebar-account-dropdown-menu') : null;
    if (!dropdown || !menu) return;

    let placeholder = null;

    const setImportantStyle = (el, prop, value) => {
      try { el.style.setProperty(prop, value, 'important'); } catch (e) { el.style[prop] = value; }
    };

    const clearInlineStyle = (el) => {
      ['position','left','top','right','bottom','margin','marginLeft','marginTop','inset','transform','zIndex','width','maxHeight','overflowY'].forEach(k => {
        try { el.style.removeProperty(k); } catch (e) { el.style[k] = ''; }
      });
    };

    const positionMenu = () => {
      if (!menu.classList.contains('show')) return;

      const margin = 8;
      const toggleRect = toggle.getBoundingClientRect();
      const menuRect = menu.getBoundingClientRect();
      const menuWidth = menuRect.width || menu.offsetWidth || 220;
      const menuHeight = menuRect.height || menu.offsetHeight || 120;

      // Prefer opening to the right of the toggle.
      let left = toggleRect.right + margin;
      if (left + menuWidth > window.innerWidth - margin) {
        left = toggleRect.left - menuWidth - margin;
      }
      left = Math.max(margin, Math.min(left, window.innerWidth - menuWidth - margin));

      // Prefer opening below; if it doesn't fit, open above.
      let top = toggleRect.bottom + margin;
      if (top + menuHeight > window.innerHeight - margin) {
        top = toggleRect.top - menuHeight - margin;
      }
      top = Math.max(margin, Math.min(top, window.innerHeight - menuHeight - margin));

      setImportantStyle(menu, 'position', 'fixed');
      setImportantStyle(menu, 'left', `${Math.round(left)}px`);
      setImportantStyle(menu, 'top', `${Math.round(top)}px`);
      setImportantStyle(menu, 'right', 'auto');
      setImportantStyle(menu, 'bottom', 'auto');
      setImportantStyle(menu, 'margin-left', '0');
      setImportantStyle(menu, 'transform', 'none');
      setImportantStyle(menu, 'z-index', '10000');
    };

    dropdown.addEventListener('show.bs.dropdown', function () {
      // Move the menu to body so it cannot be clipped by any container.
      placeholder = document.createElement('div');
      placeholder.className = 'dropdown-placeholder d-none';
      dropdown.insertBefore(placeholder, menu);
      document.body.appendChild(menu);

      // Ensure our positioning isn't overridden.
      setImportantStyle(menu, 'inset', 'auto');
      setImportantStyle(menu, 'transform', 'none');
      setImportantStyle(menu, 'margin-left', '0');
    });

    dropdown.addEventListener('shown.bs.dropdown', function () {
      requestAnimationFrame(positionMenu);
      window.addEventListener('resize', positionMenu);
      window.addEventListener('scroll', positionMenu, true);
    });

    dropdown.addEventListener('hide.bs.dropdown', function () {
      window.removeEventListener('resize', positionMenu);
      window.removeEventListener('scroll', positionMenu, true);

      if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.insertBefore(menu, placeholder);
        placeholder.parentNode.removeChild(placeholder);
        placeholder = null;
      }

      clearInlineStyle(menu);
    });
  })();

  function setSidebarExpanded(expanded) {
    if (!sidebar) return;
    sidebar.classList.toggle('expanded', expanded);
    if (mainContent) {
      mainContent.classList.toggle('persistent-sidebar-expanded', expanded);
    }
    if (expandToggle) {
      const icon = expandToggle.querySelector('.material-icons');
      if (icon) icon.textContent = expanded ? 'chevron_left' : 'chevron_right';
    }
    if (socialSection) {
      socialSection.style.display = expanded ? '' : 'none';
    }
    localStorage.setItem('persistentSidebarExpanded', expanded ? '1' : '0');
  }

  if (expandToggle) {
    const stored = localStorage.getItem('persistentSidebarExpanded');
    setSidebarExpanded(stored === '1');
    expandToggle.addEventListener('click', function() {
      const nextState = !sidebar.classList.contains('expanded');
      setSidebarExpanded(nextState);
    });
  }

  // Wire up sidebar view controls to use the same functions as the top bar
  const sidebarColumnInputs = document.querySelectorAll('input[name="sidebarColumnCount"]');
  const sidebarViewModeInputs = document.querySelectorAll('input[name="sidebarViewMode"]');
  const sidebarCardSizeInputs = document.querySelectorAll('input[name="sidebarCardSize"]');
  const sidebarShowPreviewsInput = document.getElementById('sidebarShowPreviews');
  const sidebarGridOptionsContainer = document.getElementById('sidebarGridOptionsContainer');
  
  // Get reference to the main display functions (defined in folder_view_view_partial.html)
  const contentGrids = document.querySelectorAll('.content-grid');
  
  function getCurrentDisplayPreferences() {
    const prefs = {};
    const colChecked = document.querySelector('input[name="sidebarColumnCount"]:checked');
    if (colChecked) prefs.columns = parseInt(colChecked.value, 10);
    const viewChecked = document.querySelector('input[name="sidebarViewMode"]:checked');
    if (viewChecked) prefs.view_mode = viewChecked.value;
    const sizeChecked = document.querySelector('input[name="sidebarCardSize"]:checked');
    if (sizeChecked) prefs.card_size = sizeChecked.value;
    const sp = document.getElementById('sidebarShowPreviews');
    if (sp) prefs.show_previews = !!sp.checked;
    return prefs;
  }
  
  function saveDisplayPreferences(preferences) {
    fetch('{{ url_for("folders.save_display_preferences") }}', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(preferences)
    })
    .then(res => res.json())
    .then(data => {
      if (!data.success) console.error('Failed to save preferences:', data.message);
    }).catch(err => console.error('Error saving preferences:', err));
  }
  
  function applyColumnCount(columns) {
    contentGrids.forEach(grid => {
      for (let i = 1; i <= 6; i++) grid.classList.remove(`row-cols-lg-${i}`);
      grid.classList.add(`row-cols-lg-${columns}`);
    });
    // Sync with top bar
    const topBarCol = document.querySelector(`input[name="columnCount"][value="${columns}"]`);
    if (topBarCol) topBarCol.checked = true;
    // Sync mobile pills
    document.querySelectorAll('[data-column-count]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.columnCount === String(columns));
    });
    saveDisplayPreferences(getCurrentDisplayPreferences());
  }
  
  function applyViewMode(mode, skipSave = false) {
    contentGrids.forEach(grid => grid.setAttribute('data-view-mode', mode));
    
    const tableContainers = document.querySelectorAll('.table-view-container');
    if (mode === 'list') {
      contentGrids.forEach(grid => grid.style.display = 'none');
      tableContainers.forEach(table => table.classList.remove('d-none'));
    } else {
      contentGrids.forEach(grid => grid.style.display = '');
      tableContainers.forEach(table => table.classList.add('d-none'));
    }
    
    if (sidebarGridOptionsContainer) {
      if (mode === 'grid') sidebarGridOptionsContainer.classList.remove('d-none');
      else sidebarGridOptionsContainer.classList.add('d-none');
    }
    
    // Sync with top bar
    const topBarView = document.querySelector(`input[name="viewMode"][value="${mode}"]`);
    if (topBarView) topBarView.checked = true;
    // Sync mobile pills
    document.querySelectorAll('[data-view-mode]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.viewMode === mode);
    });
    const mobileGridOptions = document.getElementById('mobileGridOptions');
    if (mobileGridOptions) {
      mobileGridOptions.style.display = mode === 'grid' ? '' : 'none';
    }
    
    if (!skipSave) saveDisplayPreferences(getCurrentDisplayPreferences());
  }
  
  function applyCardSize(size, skipSave = false) {
    contentGrids.forEach(grid => grid.setAttribute('data-card-size', size));
    // Sync with top bar
    const topBarSize = document.querySelector(`input[name="cardSize"][value="${size}"]`);
    if (topBarSize) topBarSize.checked = true;
    // Sync mobile pills
    document.querySelectorAll('[data-card-size]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.cardSize === size);
    });
    if (!skipSave) saveDisplayPreferences(getCurrentDisplayPreferences());
  }
  
  function togglePreviews(show, skipSave = false) {
    document.querySelectorAll('.content-preview').forEach(p => p.style.display = show ? 'block' : 'none');
    // Sync with top bar
    const topBarPreviews = document.getElementById('showPreviews');
    if (topBarPreviews) topBarPreviews.checked = show;
    // Sync mobile
    const mobilePreviews = document.getElementById('mobileShowPreviews');
    if (mobilePreviews) mobilePreviews.checked = show;
    if (!skipSave) saveDisplayPreferences(getCurrentDisplayPreferences());
  }
  
  // Attach event listeners
  sidebarColumnInputs.forEach(input => input.addEventListener('change', function(){ applyColumnCount(this.value); }));
  sidebarViewModeInputs.forEach(input => input.addEventListener('change', function(){ applyViewMode(this.value); }));
  sidebarCardSizeInputs.forEach(input => input.addEventListener('change', function(){ applyCardSize(this.value); }));
  if (sidebarShowPreviewsInput) {
    sidebarShowPreviewsInput.addEventListener('change', function(){ togglePreviews(this.checked); });
  }

  // --- Mobile bottom nav + sheets ---
  (function initMobileBottomNav() {
    const backdrop = document.getElementById('mobileSheetBackdrop');
    const sheetButtons = document.querySelectorAll('.mobile-nav-btn[data-sheet-target]');
    const closeButtons = document.querySelectorAll('[data-sheet-close]');
    const sheets = document.querySelectorAll('.mobile-bottom-sheet');
    const layoutToggle = document.getElementById('mobileLayoutToggle');
    const layoutFlyout = document.getElementById('mobileLayoutFlyout');
    const flyoutButtons = layoutFlyout ? layoutFlyout.querySelectorAll('[data-sheet-target]') : [];

    function positionFlyout() {
      if (!layoutFlyout || !layoutToggle || !layoutFlyout.classList.contains('show')) return;
      const margin = 12;
      layoutFlyout.style.transform = 'translateX(0)';
      const toggleRect = layoutToggle.getBoundingClientRect();
      const flyoutWidth = layoutFlyout.offsetWidth;
      let left = toggleRect.left + (toggleRect.width / 2) - (flyoutWidth / 2);
      left = Math.max(margin, Math.min(left, window.innerWidth - margin - flyoutWidth));
      layoutFlyout.style.left = `${left}px`;
      layoutFlyout.style.right = 'auto';
      layoutFlyout.style.transform = 'translateX(0)';
    }

    let openSheet = null;

    function closeSheet(keepFlyout = false) {
      sheets.forEach(s => s.classList.remove('show'));
      sheetButtons.forEach(b => b.classList.remove('active'));
      openSheet = null;
      if (backdrop) backdrop.classList.remove('show');
      if (!keepFlyout) hideFlyout();
    }

    function openSheetById(id, trigger) {
      const target = document.getElementById(id);
      if (!target) return;
      closeSheet();
      target.classList.add('show');
      if (backdrop) backdrop.classList.add('show');
      if (trigger) trigger.classList.add('active');
      openSheet = target;
    }

    function hideFlyout() {
      if (layoutFlyout) layoutFlyout.classList.remove('show');
      if (layoutToggle) layoutToggle.classList.remove('active');
    }

    sheetButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.dataset.sheetTarget;
        if (openSheet && openSheet.id === targetId) {
          closeSheet();
        } else {
          openSheetById(targetId, btn);
        }
      });
    });

    if (layoutToggle && layoutFlyout) {
      layoutToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const showing = layoutFlyout.classList.toggle('show');
        layoutToggle.classList.toggle('active', showing);
        if (showing) {
          // Close any open sheet but keep the flyout visible
          closeSheet(true);
          positionFlyout();
        }
      });

      flyoutButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const targetId = btn.dataset.sheetTarget;
          hideFlyout();
          openSheetById(targetId, btn);
        });
      });

      document.addEventListener('click', hideFlyout);
      if (backdrop) backdrop.addEventListener('click', hideFlyout);
      window.addEventListener('resize', positionFlyout);
    }

    closeButtons.forEach(btn => btn.addEventListener('click', closeSheet));
    if (backdrop) backdrop.addEventListener('click', closeSheet);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSheet();
    });

    // Hook mobile pills to existing apply* helpers
    document.querySelectorAll('[data-view-mode]').forEach(btn => {
      btn.addEventListener('click', () => applyViewMode(btn.dataset.viewMode));
    });
    document.querySelectorAll('[data-column-count]').forEach(btn => {
      btn.addEventListener('click', () => applyColumnCount(btn.dataset.columnCount));
    });
    document.querySelectorAll('[data-card-size]').forEach(btn => {
      btn.addEventListener('click', () => applyCardSize(btn.dataset.cardSize));
    });
    const mobilePreviews = document.getElementById('mobileShowPreviews');
    if (mobilePreviews) {
      mobilePreviews.checked = !!(document.getElementById('sidebarShowPreviews')?.checked);
      mobilePreviews.addEventListener('change', () => togglePreviews(mobilePreviews.checked));
    }
  })();
  
  // Initialize view mode
  const currentView = (document.querySelector('input[name="sidebarViewMode"]:checked') || {}).value || '{{ display_prefs.view_mode }}';
  if (currentView) {
    applyViewMode(currentView, true);
  }

  // --- Social search + pinned users (mirrors folder_view_social_tab) ---
  function initSidebarUserSearch(config) {
    const searchInput = document.getElementById(config.searchInputId);
    const searchBtn = document.getElementById(config.searchBtnId);
    const clearBtn = document.getElementById(config.clearBtnId);
    const resultsDiv = document.getElementById(config.resultsContainerId);
    const pinnedContainer = document.getElementById(config.pinnedContainerId);
    const pinnedList = document.getElementById(config.pinnedListId);

    if (!searchInput || !resultsDiv || !pinnedContainer) return;

    const renderResults = (users) => {
      let resultsList = document.getElementById(config.resultsListId);
      if (!resultsList) {
        resultsList = document.createElement('ul');
        resultsList.id = config.resultsListId;
        resultsList.className = 'list-unstyled';
        resultsList.style.paddingLeft = '0';
        resultsList.style.margin = '8px 0 0 0';
        resultsDiv.insertAdjacentElement('afterbegin', resultsList);
      }
      resultsList.innerHTML = '';

      let total = 0;
      (users || []).forEach(u => {
        const id = u.id;
        const username = u.username || 'User';
        const pinned = !!u.pinned;
        total += 1;

        const newLi = document.createElement('li');
        newLi.className = 'p-1 sidebar-search-result d-flex justify-content-between align-items-center';
        newLi.style.padding = '6px 4px';
        newLi.dataset.userId = id;
        newLi.dataset.pinned = pinned ? '1' : '0';

        const leftDiv = document.createElement('div');
        leftDiv.style.display = 'flex';
        leftDiv.style.alignItems = 'center';
        leftDiv.style.gap = '8px';

        const link = document.createElement('a');
        link.href = `/users/${id}`;
        link.className = 'text-white';
        link.textContent = username;
        leftDiv.appendChild(link);

        const rightDiv = document.createElement('div');
        rightDiv.style.display = 'flex';
        rightDiv.style.gap = '6px';
        const pinBtn = document.createElement('button');
        pinBtn.className = 'px-2 py-1 text-xs rounded';
        pinBtn.dataset.userId = id;
        pinBtn.textContent = pinned ? 'Unpin' : 'Pin';
        if (pinned) {
          pinBtn.classList.add('bg-yellow-500', 'text-black');
        } else {
          pinBtn.classList.add('bg-yellow-600', 'text-white');
        }
        pinBtn.addEventListener('click', function(e){
          e.preventDefault();
          togglePinFromSidebar(id, newLi, pinBtn, pinnedList);
        });
        rightDiv.appendChild(pinBtn);

        newLi.appendChild(leftDiv);
        newLi.appendChild(rightDiv);
        resultsList.appendChild(newLi);
      });

      if (total > 0) {
        resultsDiv.style.display = '';
        if (pinnedContainer) pinnedContainer.style.display = 'none';
      } else {
        resultsDiv.style.display = 'none';
        if (pinnedContainer) pinnedContainer.style.display = '';
        const msg = document.createElement('div');
        msg.className = 'text-muted small';
        msg.textContent = 'No users found.';
        resultsList.appendChild(msg);
      }
    };

    const performSearch = async (q) => {
      if (!q || !q.trim()) {
        const resultsList = document.getElementById(config.resultsListId);
        if (resultsList) resultsList.innerHTML = '';
        resultsDiv.style.display = 'none';
        if (pinnedContainer) pinnedContainer.style.display = '';
        return;
      }
      const url = `/users/api/search?q=${encodeURIComponent(q)}`;
      try {
        const resp = await fetch(url, { credentials: 'same-origin' });
        const data = await resp.json();
        renderResults((data && data.success && data.users) ? data.users : []);
      } catch (e) {
        console.error('Sidebar user search failed:', e);
      }
    };

    if (searchBtn) {
      searchBtn.addEventListener('click', function(e){
        e.preventDefault();
        performSearch(searchInput.value);
      });
    }

    if (searchInput) {
      searchInput.addEventListener('keydown', function(e){
        if (e.key === 'Enter') {
          e.preventDefault();
          performSearch(searchInput.value);
        }
        if (e.key === 'Escape' || e.key === 'Esc') {
          e.preventDefault();
          if (clearBtn) clearBtn.click();
        }
      });
      if (clearBtn) {
        clearBtn.style.display = (searchInput.value && searchInput.value.trim()) ? '' : 'none';
        searchInput.addEventListener('input', function(){
          clearBtn.style.display = (searchInput.value && searchInput.value.trim()) ? '' : 'none';
        });
        clearBtn.addEventListener('click', function(e){
          e.preventDefault();
          searchInput.value = '';
          performSearch('');
          resultsDiv.style.display = 'none';
          if (pinnedContainer) pinnedContainer.style.display = '';
          searchInput.focus();
        });
      }
    }

    if (pinnedList) {
      pinnedList.addEventListener('submit', function(e){
        try {
          e.preventDefault();
          const form = e.target;
          const match = form.action && form.action.match(/\/users\/(\d+)\/toggle_pin/);
          if (match) {
            const userId = parseInt(match[1]);
            const li = form.closest('li');
            const btn = form.querySelector('button');
            togglePinFromSidebar(userId, li, btn, pinnedList);
          } else {
            form.submit();
          }
        } catch (err) {
          console.error('Pinned list intercept failed', err);
        }
      });
    }
  }

  async function togglePinFromSidebar(userId, containerEl, buttonEl, pinnedList) {
    try {
      const response = await fetch(`/users/${userId}/toggle_pin_ajax`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const body = await response.json();
      if (body && body.success) {
        const pinned = !!body.pinned;
        if (containerEl) containerEl.dataset.pinned = pinned ? '1' : '0';
        if (buttonEl) {
          buttonEl.textContent = pinned ? 'Unpin' : 'Pin';
          if (pinned) {
            buttonEl.classList.remove('bg-yellow-600', 'text-white');
            buttonEl.classList.add('bg-yellow-500', 'text-black');
          } else {
            buttonEl.classList.remove('bg-yellow-500', 'text-black');
            buttonEl.classList.add('bg-yellow-600', 'text-white');
          }
        }

        if (pinnedList) {
          if (pinned) {
            if (!pinnedList.querySelector(`li[data-user-id='${userId}']`)) {
              const li = document.createElement('li');
              li.className = 'p-1 d-flex justify-content-between align-items-center';
              li.style.padding = '6px 4px';
              li.dataset.userId = userId;
              const usernameLabel = (containerEl && containerEl.querySelector('a')) ? containerEl.querySelector('a').textContent : 'User';
              li.innerHTML = `<div style='display:flex; align-items:center; gap:8px;'><a href='/users/${userId}' class='text-white'>${usernameLabel}</a></div><form action='/users/${userId}/toggle_pin' method='post' style='display:inline; margin-left:6px;'><button class='px-2 py-1 text-xs bg-yellow-500 text-black rounded'>Unpin</button></form>`;
              pinnedList.appendChild(li);
            }
          } else {
            const existing = pinnedList.querySelector(`li[data-user-id='${userId}']`);
            if (existing) existing.remove();
          }
        }
      } else {
        alert(body && body.message ? body.message : 'Failed to toggle pin');
      }
    } catch (e) {
      console.error('togglePinFromSidebar error:', e);
      alert('Error updating pinned status');
    }
  }

  initSidebarUserSearch({
    searchInputId: 'sidebarUserSearchCompact',
    searchBtnId: 'sidebarUserSearchBtnCompact',
    clearBtnId: 'sidebarUserClearBtnCompact',
    resultsContainerId: 'sidebarSearchResultsCompact',
    resultsListId: 'sidebarSearchResultsListCompact',
    pinnedContainerId: 'sidebarPinnedUsersContainerCompact',
    pinnedListId: 'sidebarPinnedUsersListCompact'
  });

  initSidebarUserSearch({
    searchInputId: 'mobileUserSearch',
    searchBtnId: 'mobileUserSearchBtn',
    clearBtnId: 'mobileUserClearBtn',
    resultsContainerId: 'mobileSearchResults',
    resultsListId: 'mobileSearchResultsList',
    pinnedContainerId: 'mobilePinnedUsersContainer',
    pinnedListId: 'mobilePinnedUsersList'
  });
});
</script>
